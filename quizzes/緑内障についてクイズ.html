<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>緑内障理解度クイズ - 患者・家族向け</title>
    <link rel="stylesheet" href="../css/quiz.css">
</head>
<body>
    <div class="quiz-container">
        <h1>👁️ 緑内障理解度クイズ 👁️</h1>
        <div class="subtitle">患者・家族向け - 病気への理解を深めよう</div>
        <div id="quizTitleHeader" class="quiz-title-header hidden">👁️ 緑内障理解度クイズ</div>
        <div class="top-link"><a href="../index.html">← トップページへ</a></div>

        <div id="modeSelection" class="mode-selection">
            <button class="mode-button" onclick="startQuiz('daily3')">
                📋 今日の3問
            </button>
            <button class="mode-button" onclick="startQuiz('full')">
                📚 全問モード（全17問）
            </button>

            <div id="progressStatus" class="progress-status">
                <div class="progress-status-item">
                    <span>❌ 間違えた問題:</span>
                    <span id="incorrectCount">0問</span>
                </div>
                <div class="progress-status-item">
                    <span>🆕 未挑戦の問題:</span>
                    <span id="unansweredCount">17問</span>
                </div>
                <div class="progress-status-item">
                    <span>✅ 正解した問題:</span>
                    <span id="correctCount">0問</span>
                </div>
                <div class="progress-status-item">
                    <span>📊 全問題数:</span>
                    <span id="totalQuestionsCount">17問</span>
                </div>
            </div>

            <div class="mode-description">
                <strong>今日の3問:</strong> 間違い・未挑戦を優先出題<br>
                <strong>全問モード:</strong> 全17問を順番に出題
            </div>
        </div>
        
        <div id="quizArea" class="hidden">
            <div class="quiz-status">
                <div class="status-row">
                    <span class="question-progress">問題 <span id="currentQ">1</span> / <span id="total">17</span></span>
                    <span class="score-display">正解: <span id="score">0</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>
            
            <div class="question-card" id="question1">
                <div class="question-number">問題 1</div>
                <div class="question-text">40歳以上の日本人で緑内障の患者さんの割合はどのくらいでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">約1%（100人に1人）</div>
                    <div class="option" data-answer="false">約2%（50人に1人）</div>
                    <div class="option" data-answer="true">約5%（20人に1人）</div>
                    <div class="option" data-answer="false">約10%（10人に1人）</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>緑内障は非常に多い病気で、40歳以上では5%、つまり20人に1人もいます。60歳以上では10人に1人と言われています。
                    <div class="important-note">
                        <strong>大切なポイント：</strong>これほど多くの方が患っている病気ですが、早期発見・適切な治療により、ほとんどの方が生涯にわたって視力と視野を保つことができます。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question2">
                <div class="question-number">問題 2</div>
                <div class="question-text">緑内障で最も大切な治療目標は何でしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">視力を向上させること</div>
                    <div class="option" data-answer="false">視野を広げること</div>
                    <div class="option" data-answer="true">病気の進行を遅らせ、生涯視機能を保つこと</div>
                    <div class="option" data-answer="false">眼圧を正常値まで下げること</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>緑内障は治る病気ではなく、治療は進行を遅らせて、生涯にわたり視機能を保つことが目的です。死んだ神経を元に戻すことはできないため、視野を広げることはできません。
                    <div class="important-note">
                        <strong>理解しておきたいこと：</strong>早期発見・適切な治療により、進行を大幅に遅らせることができます。生涯、視野と視力を保てたなら治療は成功です。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question3">
                <div class="question-number">問題 3</div>
                <div class="question-text">眼圧の正常値の範囲はどれでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">5～15mmHg</div>
                    <div class="option" data-answer="true">10～21mmHg</div>
                    <div class="option" data-answer="false">15～25mmHg</div>
                    <div class="option" data-answer="false">20～30mmHg</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>眼圧の正常値は10～21mmHgですが、眼によって耐えられる眼圧が異なります。また、眼圧は1日の中でも4～5程度変動し、冬は高いことが多いです。
                    <div class="important-note">
                        <strong>知っておきたいこと：</strong>昼に一度測ったぐらいでは、その眼の眼圧のことは分かりません。緑内障の治療で眼圧を下げて、進みが遅くなればその眼にとって良い眼圧になったといえます。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question4">
                <div class="question-number">問題 4</div>
                <div class="question-text">緑内障の早期発見が難しい理由として最も適切なのはどれでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">検査技術が発達していないから</div>
                    <div class="option" data-answer="true">自覚症状がほとんどないから</div>
                    <div class="option" data-answer="false">医師の診断が困難だから</div>
                    <div class="option" data-answer="false">費用が高額だから</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>緑内障は早期発見には眼科に行かないと分からないことが多く、診断されても早期や中期では自覚症状がないために、治療をやめてしまう方が多いのが問題です。
                    <div class="medical-note">
                        <strong>重要なメッセージ：</strong>自覚症状がないのはまだ余裕があるということです。自覚がないうちに見つかった人は、早く見つかってラッキーだったと思ってください。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question5">
                <div class="question-number">問題 5</div>
                <div class="question-text">開放隅角緑内障の基本的な治療方法は何でしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="true">点眼薬による治療</div>
                    <div class="option" data-answer="false">レーザー治療</div>
                    <div class="option" data-answer="false">手術治療</div>
                    <div class="option" data-answer="false">内服薬による治療</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>開放隅角緑内障は、眼圧を下げることしか治療の方法がありません。そのために、まずは点眼薬により治療をします。点眼を続けても進行するなら、手術で眼圧を下げることになります。
                    <div class="important-note">
                        <strong>治療のポイント：</strong>ある程度眼圧を下げる目標を立てますが、効果は眼によって異なるため、追加で何剤か点眼薬を併用することも多いです。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question6">
                <div class="question-number">問題 6</div>
                <div class="question-text">点眼治療で最も重要なことは何でしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">1回に多く点眼すること</div>
                    <div class="option" data-answer="true">継続して続けること</div>
                    <div class="option" data-answer="false">複数の薬を同時に点眼すること</div>
                    <div class="option" data-answer="false">眼圧が下がったら中止すること</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>点眼治療は、患者さんが自ら行う治療ですから、患者頼りになります。点眼を続けなければ、治療は成功しません。決して忘れず長く続けることが最も重要です。
                    <div class="important-note">
                        <strong>点眼のコツ：</strong>1回に1滴、異なる薬は5分以上開けて点すことを守ってください。1回に1滴以上はだめです。入れば十分ですから点しすぎないようにお願いします。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question7">
                <div class="question-number">問題 7</div>
                <div class="question-text">視野検査を受ける際に大切なことは何でしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">できるだけ多くのボタンを押すこと</div>
                    <div class="option" data-answer="true">焦らず正直に検査を受けること</div>
                    <div class="option" data-answer="false">眼を積極的に動かすこと</div>
                    <div class="option" data-answer="false">見えない光も見えたと答えること</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>視野検査は、そのときの患者さんの気持ちや体調がよく反映される検査です。落ち込んでいたり、緊張してドキドキして検査を受けるとうまくいきません。
                    <div class="medical-note">
                        <strong>検査のコツ：</strong>視野検査は正常な方でも見えない光を提示したりして検査するので、焦らず正直に受けるようにお願いします。眼を動かすと検査結果が良く出てしまいます。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question8">
                <div class="question-number">問題 8</div>
                <div class="question-text">緑内障と診断された時の心構えとして最も適切なのはどれでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">すぐに仕事を辞める準備をする</div>
                    <div class="option" data-answer="false">人生設計を大幅に変更する</div>
                    <div class="option" data-answer="true">早く見つかって運が良かったと思って定期通院する</div>
                    <div class="option" data-answer="false">失明は避けられないと諦める</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>緑内障と診断されたら、早く見つかって運が良かったと思って、定期的に通院をしてください。仕事や生活を変える必要はありません。
                    <div class="important-note">
                        <strong>大切な考え方：</strong>かなりの高眼圧や末期の方以外は、じっくり治療に専念し、仕事や生活パターンを変えず、あせらず過ごすことが重要です。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question9">
                <div class="question-number">問題 9</div>
                <div class="question-text">緑内障で自覚症状が出ている場合、どのような状態でしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">まだ初期段階で余裕がある</div>
                    <div class="option" data-answer="true">中心に視野欠損が出ていてピンチの状態</div>
                    <div class="option" data-answer="false">治療の必要がない軽度の状態</div>
                    <div class="option" data-answer="false">手術が必要な末期の状態</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>霞んだり、文字を読み飛ばしたりといった自覚症状が出ている場合は、中心に視野欠損が出ています。この様な自覚症状が出ている場合はピンチです。
                    <div class="medical-note">
                        <strong>重要：</strong>緑内障の視野欠損は暗くなりません。霞んできてそのうち濃い明るい霧の中にいるように感じます。積極的に治療に参加して、何とか生涯、視野や視力を保てるようにしましょう。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question10">
                <div class="question-number">問題 10</div>
                <div class="question-text">点眼薬の副作用として最も一般的なものは何でしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="true">眼の充血</div>
                    <div class="option" data-answer="false">視力低下</div>
                    <div class="option" data-answer="false">眼圧上昇</div>
                    <div class="option" data-answer="false">頭痛</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>目薬には必ず副作用があります。ほとんどに共通する副作用は充血ですが、たいていの方が受け入れられます。アレルギーがでたら中止です。
                    <div class="important-note">
                        <strong>注意点：</strong>目薬で、喘息や息切れ、動悸、めまい、などの症状を起こすこともありますから、そのように感じたら主治医に相談をお願いします。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question11">
                <div class="question-number">問題 11</div>
                <div class="question-text">初期の開放隅角緑内障で、眼圧が「18mmHg」の患者さんについて正しいのはどれでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">正常値なので治療は不要</div>
                    <div class="option" data-answer="true">その眼に合った適切な眼圧まで下げる必要がある</div>
                    <div class="option" data-answer="false">すぐに手術が必要</div>
                    <div class="option" data-answer="false">経過観察のみで十分</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>眼圧が正常範囲内（10-21mmHg）でも、その眼にとって高すぎる場合があります。初期緑内障では、その患者さんの眼に適した「目標眼圧」まで下げることで、進行を防ぐことができます。これを「正常眼圧緑内障」と呼ぶこともあります。
                </div>
            </div>

            <div class="question-card hidden" id="question12">
                <div class="question-number">問題 12</div>
                <div class="question-text">初期の開放隅角緑内障と診断された患者さんの理想的な通院間隔はどれでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">半年に1回</div>
                    <div class="option" data-answer="true">2-3ヶ月に1回</div>
                    <div class="option" data-answer="false">1年に1回</div>
                    <div class="option" data-answer="false">症状が出たときのみ</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>初期緑内障では、治療効果の確認と病気の進行チェックのため、2-3ヶ月に1回の定期通院が推奨されます。眼圧測定、視野検査、眼底検査を定期的に行い、点眼効果を評価します。自覚症状がなくても継続通院が重要です。
                </div>
            </div>

            <div class="question-card hidden" id="question13">
                <div class="question-number">問題 13</div>
                <div class="question-text">緑内障の診断で、OCT（眼底三次元画像解析）検査の目的として最も適切なのはどれでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">白内障の程度を調べる</div>
                    <div class="option" data-answer="false">眼圧を正確に測定する</div>
                    <div class="option" data-answer="true">視神経の厚みを詳しく調べる</div>
                    <div class="option" data-answer="false">角膜の状態を確認する</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>OCT検査では、視神経線維層の厚みを数値で測定できます。初期緑内障では視野に異常が出る前に、すでに視神経が薄くなっていることがあります。この検査により、より早期の診断と経過観察が可能になります。
                </div>
            </div>

            <div class="question-card hidden" id="question14">
                <div class="question-number">問題 14</div>
                <div class="question-text">適切な治療を受けている初期緑内障の患者さんの多くは、将来的にどうなるでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">ほぼ確実に失明する</div>
                    <div class="option" data-answer="false">必ず手術が必要になる</div>
                    <div class="option" data-answer="true">生涯にわたって視機能を保てる</div>
                    <div class="option" data-answer="false">数年で急激に悪化する</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>初期で発見され、適切な治療を継続している緑内障患者さんの多くは、生涯にわたって日常生活に支障のない視機能を保つことができます。大切なのは、定期通院と点眼治療の継続です。過度に心配せず、医師と協力して治療を続けることが重要です。
                </div>
            </div>

            <div class="question-card hidden" id="question15">
                <div class="question-number">問題 15</div>
                <div class="question-text">2種類の点眼薬が処方された場合、点眼の間隔はどのくらい空けるべきでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">すぐに続けて点眼してよい</div>
                    <div class="option" data-answer="true">5分以上間隔を空ける</div>
                    <div class="option" data-answer="false">1時間以上間隔を空ける</div>
                    <div class="option" data-answer="false">同じ時間に同時に点眼する</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>複数の点眼薬を使用する場合は、5分以上間隔を空けて点眼します。連続して点眼すると、先に点眼した薬が後の薬で洗い流されてしまい、効果が減少する可能性があります。時間に余裕を持って点眼しましょう。
                </div>
            </div>

            <div class="question-card hidden" id="question16">
                <div class="question-number">問題 16</div>
                <div class="question-text">緑内障の患者さんが視野検査を受ける理想的な頻度はどれでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">毎月1回</div>
                    <div class="option" data-answer="true">半年に1回</div>
                    <div class="option" data-answer="false">2年に1回</div>
                    <div class="option" data-answer="false">症状が悪化した時のみ</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>初期緑内障では、視野検査は半年に1回程度の頻度で行うのが一般的です。病気の進行を早期に発見し、治療効果を評価するために定期的な検査が重要です。進行が速い場合や治療変更時にはより頻繁に行うこともあります。
                </div>
            </div>

            <div class="question-card hidden" id="question17">
                <div class="question-number">問題 17</div>
                <div class="question-text">視野検査を初めて受ける患者さんへの事前説明として最も重要なのはどれでしょうか？</div>
                <div class="options">
                    <div class="option" data-answer="false">「痛くない検査なので心配いりません」</div>
                    <div class="option" data-answer="true">「集中力が必要で時間がかかりますが、正直に答えてください」</div>
                    <div class="option" data-answer="false">「全部の光が見えるよう頑張ってください」</div>
                    <div class="option" data-answer="false">「疲れたら途中で休憩できます」</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>視野検査は集中力を要し、見えない光もある正常な検査であることを事前に説明することが重要です。「頑張って見ようとする」と正確な結果が得られません。リラックスして正直に反応することを伝えましょう。
                </div>
            </div>

            <div class="buttons">
                <button class="next-button hidden" onclick="nextQuestion()">次の問題へ</button>
                <button class="result-button hidden" onclick="showFinalScore()">🎊 結果発表へ 🎊</button>
            </div>
        </div>
    </div>

    <script src="quiz-config.js"></script>
    <script>
        const QUIZ_ID = 'ryokunaisho';
        const TOTAL_QUESTIONS = 17;

        // 全クイズ一覧（シャッフル機能用）
        const ALL_QUIZZES = [
            'コンタクト処方の基本クイズ.html',
            '大人の遠く用メガネ合わせクイズ.html',
            '弱視クイズ.html',
            '斜視クイズ.html',
            '白内障についてクイズ.html',
            '緑内障についてクイズ.html',
            '老眼鏡合わせ_クイズ.html',
            '自治体の緑内障検診の制度のクイズ.html',
            '花粉症についてのクイズ.html',
            '近視についてのクイズ.html',
            '院内ルール確認クイズ.html'
        ];
        const CURRENT_QUIZ_FILE = decodeURIComponent(location.pathname.split('/').pop());

        let currentQuestion = 1;
        let score = 0;
        let totalQuestions = 17;
        let questionList = [];
        let isDaily = false;

        const allQuestions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17];

        // ページ読み込み時に学習状況を更新
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressStatus();

            // URLパラメータをチェック
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');

            // モードが指定されていたら自動開始
            if (mode === 'daily3' || mode === 'full') {
                startQuiz(mode);
            }
        });

        // 学習状況の表示を更新
        function updateProgressStatus() {
            const incorrectList = getIncorrectQuestions(QUIZ_ID);
            const unansweredList = getUnansweredQuestions(QUIZ_ID, TOTAL_QUESTIONS);
            const correctNum = TOTAL_QUESTIONS - incorrectList.length - unansweredList.length;

            const incorrectCount = document.getElementById('incorrectCount');
            const unansweredCount = document.getElementById('unansweredCount');
            const correctCount = document.getElementById('correctCount');
            const totalQuestionsCount = document.getElementById('totalQuestionsCount');

            if (incorrectCount) {
                incorrectCount.textContent = `${incorrectList.length}問`;
            }
            if (unansweredCount) {
                unansweredCount.textContent = `${unansweredList.length}問`;
            }
            if (correctCount) {
                correctCount.textContent = `${correctNum}問`;
            }
            if (totalQuestionsCount) {
                totalQuestionsCount.textContent = `${TOTAL_QUESTIONS}問`;
            }
        }

        // 配列シャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function flashCorrect(element) {
            const card = element.closest('.question-card');
            if (card) {
                card.classList.add('correct-flash');
                setTimeout(() => card.classList.remove('correct-flash'), 400);
            }
        }

        function celebrateResult(isPerfect) {
            if (navigator.vibrate) {
                if (isPerfect) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                } else {
                    navigator.vibrate([50, 30, 50]);
                }
            }

            const emojis = isPerfect
                ? ['🎉', '🏆', '👑', '💯', '⭐', '✨', '🌟', '🥇']
                : ['🎉', '⭐', '✨', '👏', '🎊'];
            const count = isPerfect ? 15 : 8;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 3;

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.className = 'celebrate-emoji';
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.left = (centerX - 100 + Math.random() * 200) + 'px';
                    emoji.style.top = (centerY + Math.random() * 50) + 'px';
                    document.body.appendChild(emoji);
                    setTimeout(() => emoji.remove(), 1000);
                }, i * 100);
            }
        }

        function startQuiz(mode) {
            document.querySelector('h1').classList.add('hidden');
            document.querySelector('.subtitle').classList.add('hidden');
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('quizArea').classList.remove('hidden');
            document.getElementById('quizTitleHeader').classList.remove('hidden');

            if (mode === 'daily3') {
                isDaily = true;
                totalQuestions = 3;
                questionList = getWeightedRandomQuestions(QUIZ_ID, TOTAL_QUESTIONS, 3);
            } else {
                isDaily = false;
                totalQuestions = TOTAL_QUESTIONS;
                questionList = [...allQuestions];
            }

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if (questionList.includes(i)) {
                    if (i === questionList[0]) {
                        questionElement.classList.remove('hidden');
                    } else {
                        questionElement.classList.add('hidden');
                    }
                } else {
                    if(document.getElementById(`question${i}`)){
                       document.getElementById(`question${i}`).style.display = 'none';
                    }
                }
            }
            
            currentQuestion = 0;
            updateQuestionNumbers();
            document.getElementById('total').textContent = totalQuestions;
            shuffleOptions(questionList[0]);
            updateProgress();
        }

        function getRandomQuestions(count) {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function updateQuestionNumbers() {
            questionList.forEach((questionId, index) => {
                const questionElement = document.getElementById(`question${questionId}`);
                if (questionElement) {
                    const questionNumber = questionElement.querySelector('.question-number');
                    questionNumber.textContent = `問題 ${index + 1}`;
                }
            });
        }

        function shuffleOptions(questionId) {
            if (!questionId) return;
            const container = document
                .getElementById(`question${questionId}`)
                .querySelector('.options');
            if (!container) return;
            
            for (let i = container.children.length; i >= 0; i--) {
                const rand = Math.floor(Math.random() * i);
                if (container.children[rand]) {
                    container.appendChild(container.children[rand]);
                }
            }
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQ').textContent = currentQuestion + 1;
        }

        function selectAnswer(selectedOption) {
            const currentQuestionId = questionList[currentQuestion];
            const currentQuestionElement = document.getElementById(`question${currentQuestionId}`);
            const options = currentQuestionElement.querySelectorAll('.option');
            const feedback = currentQuestionElement.querySelector('.feedback');
            const explanation = currentQuestionElement.querySelector('.explanation');
            const nextButton = document.querySelector('.next-button');
            const resultButton = document.querySelector('.result-button');
            
            const isCorrect = selectedOption.dataset.answer === 'true';
            let correctAnswerText = '';
            
            options.forEach(option => {
                if (option.dataset.answer === 'true') {
                    correctAnswerText = option.textContent;
                }
            });
            
            options.forEach(option => {
                option.classList.add('disabled');
                if (option.dataset.answer === 'true') {
                    option.classList.add('correct');
                } else if (option === selectedOption && option.dataset.answer === 'false') {
                    option.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                feedback.textContent = '🎉 正解です！';
                feedback.className = 'feedback correct';
                score++;
                flashCorrect(selectedOption);
            } else {
                feedback.textContent = `❌ 不正解です。正解は「${correctAnswerText}」です。`;
                feedback.className = 'feedback incorrect';
            }

            // 問題ごとの結果を記録（復習・未挑戦モード用）
            if (typeof recordQuestionResult === 'function') {
                recordQuestionResult(QUIZ_ID, currentQuestionId, isCorrect);
            }

            feedback.style.display = 'block';
            explanation.classList.remove('hidden');

            if (currentQuestion < totalQuestions - 1) {
                nextButton.classList.remove('hidden');
            } else {
                resultButton.classList.remove('hidden');
            }

            updateScore();

            // スマホ用：回答後にフィードバックが画面上部に来るようスクロール
            setTimeout(() => {
                feedback.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function nextQuestion() {
            const currentQuestionId = questionList[currentQuestion];
            document.getElementById(`question${currentQuestionId}`).classList.add('hidden');
            
            currentQuestion++;
            const nextQuestionId = questionList[currentQuestion];
            
            shuffleOptions(nextQuestionId);
            document.getElementById(`question${nextQuestionId}`).classList.remove('hidden');
            document.querySelector('.next-button').classList.add('hidden');
            updateProgress();
        }

        function showFinalScore() {
            questionList.forEach(questionId => {
                const qElem = document.getElementById(`question${questionId}`);
                if (qElem) {
                    qElem.classList.add('hidden');
                }
            });
            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.quiz-status').classList.add('hidden');

            const percentage = Math.round((score / totalQuestions) * 100);
            let title, message;

            if (isDaily) {
                if (score === totalQuestions) {
                    title = '🎉 素晴らしい！ 🎉';
                    message = `${totalQuestions}問全問正解！緑内障について とてもよく理解されています。\nこの知識を活かして、安心して治療に取り組んでください。`;
                } else if (score >= Math.ceil(totalQuestions * 0.8)) {
                    title = '👍 よく理解されています！ 👍';
                    message = `基本的なポイントは よく押さえられています。\n間違えた箇所を確認して、さらに理解を深めましょう。`;
                } else {
                    title = '📖 学習を続けましょう！ 📖';
                    message = `緑内障について 理解を深める良い機会になりました。\n病気のことをよく知ることで、より安心して治療に取り組めます。`;
                }
            } else {
                if (score === totalQuestions) {
                    title = '🏆 完璧な理解度！ 🏆';
                    message = `全問正解！緑内障について 非常によく理解されています。\nこの知識があれば、自信を持って治療に取り組むことができます。\n定期的な通院と点眼治療を続けて、生涯にわたって視機能を保っていきましょう。`;
                } else if (score >= totalQuestions * 0.9) {
                    title = '🌟 優秀な理解度！ 🌟';
                    message = `とても良い結果です！緑内障の重要ポイントを しっかりと理解されています。\n少し復習すれば、さらに完璧な知識になります。\n安心して医師と治療計画を立てていってください。`;
                } else if (score >= totalQuestions * 0.8) {
                    title = '📚 良い理解度です！ 📚';
                    message = `基本的な知識は しっかりと身についています。\n間違えた部分を見直すことで、より深い理解が得られます。\n病気について知ることは、治療成功への第一歩です。`;
                } else if (score >= totalQuestions * 0.7) {
                    title = '🌱 理解が深まりました！ 🌱';
                    message = `緑内障について 基本的なことは理解できています。\n不安な点や分からないことは、遠慮なく医師に相談しましょう。\n正しい知識を持つことで、より良い治療が受けられます。`;
                } else {
                    title = '💪 学習のスタートです！ 💪';
                    message = `緑内障について 学ぶ良いきっかけになりました。\n病気を理解することは とても大切です。分からないことは医師や看護師に積極的に質問しましょう。\n正しい知識があれば、安心して治療に取り組むことができます。`;
                }
            }
            
            const scoreHTML = `<span class="final-score-highlight">最終スコア : ${score}/${totalQuestions}（${percentage}%）</span>`;
            const evaluationHTML = `<div class="result-evaluation">${title}</div>`;
            const messageHTML = `<div>${message.replace(/\n/g, '<br>')}</div>`;
            const titleHTML = `<div class="result-title">🎊 結果発表 🎊</div>`;

            document.getElementById('resultDetail').innerHTML = titleHTML + evaluationHTML + scoreHTML + messageHTML;

            document.querySelector('.quiz-container').classList.add('hidden');
            document.getElementById('finalResult').classList.remove('hidden');
            document.querySelector('.shuffle-button').classList.remove('hidden');
            document.querySelector('.retry-button').classList.remove('hidden');
            document.querySelector('.record-button').classList.remove('hidden');
            document.querySelector('.home-button-small').classList.remove('hidden');
            document.querySelector('.top-link').classList.add('hidden');

            window.scrollTo({ top: 0, behavior: 'smooth' });

            const isPerfect = score === totalQuestions;
            setTimeout(() => {
                celebrateResult(isPerfect);
            }, 300);

            // マイページ用に結果を記録
            recordQuizResult(QUIZ_ID, score, totalQuestions);
        }

        function resetQuiz() {
            document.querySelector('.quiz-container').classList.remove('hidden');
            document.getElementById('finalResult').classList.add('hidden');
            score = 0;
            updateScore();

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if (questionElement) {
                    questionElement.style.display = '';
                    questionElement.classList.add('hidden');

                    const options = questionElement.querySelectorAll('.option');
                    options.forEach(option => {
                        option.classList.remove('correct', 'incorrect', 'disabled');
                    });

                    questionElement.querySelector('.feedback').style.display = 'none';
                    questionElement.querySelector('.explanation').classList.add('hidden');
                }
            }

            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.shuffle-button').classList.add('hidden');
            document.querySelector('.retry-button').classList.add('hidden');
            document.querySelector('.record-button').classList.add('hidden');
            document.querySelector('.home-button-small').classList.add('hidden');
            document.querySelector('.top-link').classList.remove('hidden');

            document.querySelector('.quiz-status').classList.remove('hidden');

            if (totalQuestions === 3) {
                startQuiz('daily3');
            } else {
                startQuiz('full');
            }
        }

        function goHome() {
            document.querySelector('.quiz-container').classList.remove('hidden');
            document.getElementById('finalResult').classList.add('hidden');
            document.getElementById('quizArea').classList.add('hidden');

            document.querySelector('h1').classList.remove('hidden');
            document.querySelector('.subtitle').classList.remove('hidden');
            document.getElementById('quizTitleHeader').classList.add('hidden');

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if (questionElement) {
                    questionElement.style.display = '';
                    questionElement.classList.add('hidden');

                    const options = questionElement.querySelectorAll('.option');
                    options.forEach(option => {
                        option.classList.remove('correct', 'incorrect', 'disabled');
                    });

                    questionElement.querySelector('.feedback').style.display = 'none';
                    questionElement.querySelector('.explanation').classList.add('hidden');
                }
            }

            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.shuffle-button').classList.add('hidden');
            document.querySelector('.retry-button').classList.add('hidden');
            document.querySelector('.record-button').classList.add('hidden');
            document.querySelector('.home-button-small').classList.add('hidden');
            document.querySelector('.top-link').classList.remove('hidden');
            document.querySelector('.quiz-status').classList.remove('hidden');

            currentQuestion = 1;
            score = 0;
            totalQuestions = TOTAL_QUESTIONS;
            questionList = [];
            isDaily = false;

            updateScore();
            updateProgressStatus();

            document.getElementById('modeSelection').classList.remove('hidden');
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        // シャッフル3問：別ジャンルのクイズへ
        function goToRandomQuiz() {
            const otherQuizzes = ALL_QUIZZES.filter(q => q !== CURRENT_QUIZ_FILE);
            const randomQuiz = otherQuizzes[Math.floor(Math.random() * otherQuizzes.length)];
            window.location.href = encodeURI(randomQuiz) + '?mode=daily3';
        }

        // もう3問：このクイズの今日の3問を再開
        function restartThisQuiz() {
            window.location.href = encodeURI(CURRENT_QUIZ_FILE) + '?mode=daily3';
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('option') && !e.target.classList.contains('disabled')) {
                selectAnswer(e.target);
            }
        });
    </script>

    <div id="finalResult" class="final-score-card hidden">
      <div id="resultDetail" class="result-detail"></div>
      <div class="result-buttons">
        <div class="result-buttons-row primary">
          <button class="shuffle-button hidden" onclick="goToRandomQuiz()">🎲 シャッフル3問<span class="btn-sub">別ジャンル</span></button>
          <button class="retry-button hidden" onclick="restartThisQuiz()">🔄 もう3問<span class="btn-sub">このクイズ</span></button>
        </div>
        <div class="result-buttons-row secondary">
          <a href="../mypage.html" class="record-button hidden">📊 記録</a>
          <a href="../index.html" class="home-button-small hidden">🏠 ホーム</a>
        </div>
      </div>
    </div>

</body>
</html>