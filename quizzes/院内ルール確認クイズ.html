<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>院内ルール確認クイズ - スタッフ向け</title>
    <link rel="stylesheet" href="../css/quiz.css">
</head>
<body>
    <div class="quiz-container">
        <h1>🏥 院内ルール確認クイズ 🏥</h1>
        <div class="subtitle">スタッフ向け - 円滑な患者様対応のために</div>
        <div class="top-link"><a href="../index.html">← トップページへ</a></div>

        <div id="quizTitleHeader" class="quiz-title-header hidden">🏥 院内ルール確認クイズ</div>

        <div id="modeSelection" class="mode-selection">
            <button class="mode-button" onclick="startQuiz('daily')">
                📋 今日の3問
            </button>
            <button class="mode-button" onclick="startQuiz('full')">
                📚 全問モード（全15問）
            </button>

            <div id="progressStatus" class="progress-status">
                <div class="progress-status-item">
                    <span>❌ 間違えた問題:</span>
                    <span id="incorrectCount">0問</span>
                </div>
                <div class="progress-status-item">
                    <span>🆕 未挑戦の問題:</span>
                    <span id="unansweredCount">15問</span>
                </div>
                <div class="progress-status-item">
                    <span>✅ 正解した問題:</span>
                    <span id="correctCount">0問</span>
                </div>
                <div class="progress-status-item">
                    <span>📊 全問題数:</span>
                    <span id="totalQuestionsCount">15問</span>
                </div>
            </div>

            <div class="mode-description">
                <strong>今日の3問:</strong> 間違い・未挑戦を優先出題<br>
                <strong>全問モード:</strong> 全15問を順番に出題
            </div>
        </div>
        
        <div id="quizArea" class="hidden">
            <div class="quiz-status">
                <div class="status-row">
                    <span class="question-progress">問題 <span id="currentQ">1</span> / <span id="total">15</span></span>
                    <span class="score-display">正解: <span id="score">0</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>
            
            <div class="question-card" id="question1">
                <div class="question-number">問題 1</div>
                <div class="question-text">当院の 休診日は 何曜日ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">月曜日</div>
                    <div class="option" data-answer="false">火曜日</div>
                    <div class="option" data-answer="true">水曜日</div>
                    <div class="option" data-answer="false">木曜日</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>2025年4月1日より、休診日が「水曜日」に変更されました。
                </div>
            </div>

            <div class="question-card hidden" id="question2">
                <div class="question-number">問題 2</div>
                <div class="question-text">予約が 満席（❌表示）の場合、電話での 予約は 可能ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">可能です</div>
                    <div class="option" data-answer="false">他の患者様の 迷惑にならない 時間帯であれば 可能です</div>
                    <div class="option" data-answer="true">承ることは できません</div>
                    <div class="option" data-answer="false">緊急の場合は 可能です</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>予約が満席（❌表示）の場合、お電話等での予約は承ることができませんので、ご了承くださいと明記されています。
                </div>
            </div>

            <div class="question-card hidden" id="question3">
                <div class="question-number">問題 3</div>
                <div class="question-text">予約を 無断キャンセルした場合、どのような 対応が 取られることが ありますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">特に 影響は ありません</div>
                    <div class="option" data-answer="false">次回から 必ず電話で 予約するよう お願いされます</div>
                    <div class="option" data-answer="true">今後の 予約を お断りする 場合が ございます</div>
                    <div class="option" data-answer="false">キャンセル料が 発生します</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>無断キャンセルは固くお断りしており、他の患者様のご迷惑となるため、今後の予約をお断りする場合がございます。
                </div>
            </div>

            <div class="question-card hidden" id="question4">
                <div class="question-number">問題 4</div>
                <div class="question-text">発熱がある 患者様が 来院を希望した場合、どのように 案内すべきですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">体温計で 検温後、受診可能です</div>
                    <div class="option" data-answer="true">症状が 改善してから 予約を 取るよう 案内します</div>
                    <div class="option" data-answer="false">マスク着用で 受診を促します</div>
                    <div class="option" data-answer="false">隔離された 場所で 診察可能です</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>発熱がある方は受診をお控えいただき、体調不良の際は症状が改善してから予約を取るよう案内されています。また、37度以上の発熱の方、コロナ・インフルエンザ疑いの方は受診できません。
                </div>
            </div>

            <div class="question-card hidden" id="question5">
                <div class="question-number">問題 5</div>
                <div class="question-text">初めて 当院を 受診する患者様に、受付を スムーズに 進めるために 推奨されることは 何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">事前に電話で 詳細な病歴を 伝える</div>
                    <div class="option" data-answer="false">診察券を 忘れずに持参する</div>
                    <div class="option" data-answer="true">問診票を ダウンロードして 記入しておく</div>
                    <div class="option" data-answer="false">紹介状を 持参する</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>初診の方は、問診票をダウンロードしてご記入いただくと、受付がスムーズになると案内されています。
                </div>
            </div>

            <div class="question-card hidden" id="question6">
                <div class="question-number">問題 6</div>
                <div class="question-text">コンタクトレンズの 処方箋（指示書）は、どのような 目的の場合に 発行されますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">インターネット通販サイトで 購入するため</div>
                    <div class="option" data-answer="false">他店で 購入するため</div>
                    <div class="option" data-answer="true">2階の「エースコンタクト」を 利用する方へ</div>
                    <div class="option" data-answer="false">友人から 譲り受けた コンタクトレンズを 使用するため</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>コンタクトレンズの処方箋（指示書）は、2階の「エースコンタクト」をご利用の方へのみ発行しており、他店やインターネット通販サイト等での購入目的での発行は行っていません。
                </div>
            </div>

            <div class="question-card hidden" id="question7">
                <div class="question-number">問題 7</div>
                <div class="question-text">エースコンタクトで 先に受付を済ませた患者様が 当院で コンタクト処方を 希望する場合、事前の予約は 必要ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">必ず 予約が 必要です</div>
                    <div class="option" data-answer="true">予約なしでも 診察可能です</div>
                    <div class="option" data-answer="false">電話で 事前連絡が 必要です</div>
                    <div class="option" data-answer="false">午後の診察時間内に限って 予約なしで 可能です</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>先にエースコンタクトで受付を済ませた方は、予約なしでも診察可能と記載されています。受付時間内にご来院ください。
                </div>
            </div>

            <div class="question-card hidden" id="question8">
                <div class="question-number">問題 8</div>
                <div class="question-text">安全のため、コンタクトレンズの 処方の対象年齢は 何歳からですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">3歳から</div>
                    <div class="option" data-answer="true">小学生 6年生以上から</div>
                    <div class="option" data-answer="false">中学生以上から</div>
                    <div class="option" data-answer="false">18歳以上から</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>コンタクトレンズの処方は、安全のため小学生6年生以上を対象としています。
                </div>
            </div>

            <div class="question-card hidden" id="question9">
                <div class="question-number">問題 9</div>
                <div class="question-text">斜視・弱視・色覚検査を 希望する患者様は、どのように 予約を 取る必要が ありますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">ウェブサイトの 「一般予約」から 予約する</div>
                    <div class="option" data-answer="false">予約なしで 直接来院する</div>
                    <div class="option" data-answer="true">電話での 予約が 必要です</div>
                    <div class="option" data-answer="false">紹介状が必須で、当院からは 予約できません</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>斜視・弱視・色覚検査を希望する方は、お一人おひとりの状態に合わせた丁寧な検査のため時間を要するため、電話での予約をお願いしています。
                </div>
            </div>

            <div class="question-card hidden" id="question10">
                <div class="question-number">問題 10</div>
                <div class="question-text">ふじみ野市・富士見市・三芳町の 緑内障検診の 自己負担金は いくらですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">無料です</div>
                    <div class="option" data-answer="false">500円（現金のみ）</div>
                    <div class="option" data-answer="true">1,000円（現金のみ）</div>
                    <div class="option" data-answer="false">2,000円（クレジットカード可）</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>緑内障検診の自己負担金は1,000円（現金のみ）と記載されています。
                </div>
            </div>

            <div class="question-card hidden" id="question11">
                <div class="question-number">問題 11</div>
                <div class="question-text">初めて コンタクトレンズの処方で 来院される患者様の 午前の受付終了時間は 何時ですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">午前 12:30まで</div>
                    <div class="option" data-answer="false">午前 12:00まで</div>
                    <div class="option" data-answer="false">午前 11:30まで</div>
                    <div class="option" data-answer="false">午後 13:00まで</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>コンタクトが初めての方は、午前12:30までに受付を済ませる必要があります。
                </div>
            </div>

            <div class="question-card hidden" id="question12">
                <div class="question-number">問題 12</div>
                <div class="question-text">2回目以降の コンタクトレンズ受診の 午後の受付終了時間は 何時ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">午後 17:30まで</div>
                    <div class="option" data-answer="false">午後 18:00まで</div>
                    <div class="option" data-answer="true">午後 18:30まで</div>
                    <div class="option" data-answer="false">午後 19:00まで</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>2回目以降のコンタクト受診の受付は、午後は18:30まで可能です。
                </div>
            </div>

            <div class="question-card hidden" id="question13">
                <div class="question-number">問題 13</div>
                <div class="question-text">ウェブ予約について、 「受付のための予約」と ありますが、これは 何を意味しますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">予約時間ちょうどに 診察が開始されることを 保証するものです</div>
                    <div class="option" data-answer="false">検査・診察までの 待ち時間は 発生しないことを 意味します</div>
                    <div class="option" data-answer="true">受付の順番を 確保するものであり、検査・診察までの 待ち時間は 生じます</div>
                    <div class="option" data-answer="false">必ず希望する医師に 診てもらえることを 意味します</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>ウェブ予約は受付のための予約であり、検査・診察までの待ち時間は生じる旨が記載されています。
                </div>
            </div>

            <div class="question-card hidden" id="question14">
                <div class="question-number">問題 14</div>
                <div class="question-text">小児予約外来は、何曜日に 予約枠が ありますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">月・水・金曜日</div>
                    <div class="option" data-answer="true">火・木・金曜日</div>
                    <div class="option" data-answer="false">月・火・水曜日</div>
                    <div class="option" data-answer="false">土・日・祝日</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>小児予約外来は「火・木・金曜」の「11時から」と「15:30から」の予約枠があると記載されています。
                </div>
            </div>

            <div class="question-card hidden" id="question15">
                <div class="question-number">問題 15</div>
                <div class="question-text">当院の代診医師が 対応していない 検査や検診は どれですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">一般眼科診察</div>
                    <div class="option" data-answer="false">コンタクト処方</div>
                    <div class="option" data-answer="true">「市の緑内障検診」や 「斜視・弱視」</div>
                    <div class="option" data-answer="false">眼鏡処方</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>代診医師は「市の緑内障検診」や「斜視・弱視」には対応していないと明記されています。
                </div>
            </div>

            <div class="buttons">
                <button class="next-button hidden" onclick="nextQuestion()">次の問題へ</button>
                <button class="result-button hidden" onclick="showFinalScore()">🎊 結果発表へ 🎊</button>
            </div>
        </div>
    </div>

    <script src="quiz-config.js"></script>
    <script>
        const QUIZ_ID = 'innai-rule';
        const TOTAL_QUESTIONS = 15;

        // 全クイズ一覧（シャッフル機能用）
        const ALL_QUIZZES = [
            'コンタクト処方の基本クイズ.html',
            '大人の遠く用メガネ合わせクイズ.html',
            '弱視クイズ.html',
            '斜視クイズ.html',
            '白内障についてクイズ.html',
            '緑内障についてクイズ.html',
            '老眼鏡合わせ_クイズ.html',
            '自治体の緑内障検診の制度のクイズ.html',
            '花粉症についてのクイズ.html',
            '近視についてのクイズ.html',
            '院内ルール確認クイズ.html'
        ];
        const CURRENT_QUIZ_FILE = decodeURIComponent(location.pathname.split('/').pop());

        let currentQuestion = 1;
        let score = 0;
        let totalQuestions = 15;
        let questionList = [];
        let isDaily = false;

        const allQuestions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];

        // ページ読み込み時に学習状況を更新
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressStatus();
        });

        // 学習状況の表示を更新
        function updateProgressStatus() {
            const incorrectList = getIncorrectQuestions(QUIZ_ID);
            const unansweredList = getUnansweredQuestions(QUIZ_ID, TOTAL_QUESTIONS);
            const correctNum = TOTAL_QUESTIONS - incorrectList.length - unansweredList.length;

            const incorrectCount = document.getElementById('incorrectCount');
            const unansweredCount = document.getElementById('unansweredCount');
            const correctCount = document.getElementById('correctCount');
            const totalQuestionsCount = document.getElementById('totalQuestionsCount');

            if (incorrectCount) {
                incorrectCount.textContent = `${incorrectList.length}問`;
            }
            if (unansweredCount) {
                unansweredCount.textContent = `${unansweredList.length}問`;
            }
            if (correctCount) {
                correctCount.textContent = `${correctNum}問`;
            }
            if (totalQuestionsCount) {
                totalQuestionsCount.textContent = `${TOTAL_QUESTIONS}問`;
            }
        }

        // 正解時フラッシュ効果
        function flashCorrect(element) {
            const card = element.closest('.question-card');
            if (card) {
                card.classList.add('correct-flash');
                setTimeout(() => card.classList.remove('correct-flash'), 400);
            }
        }

        // 結果発表エフェクト
        function celebrateResult(isPerfect) {
            // 振動フィードバック（スマホのみ）
            if (navigator.vibrate) {
                if (isPerfect) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                } else {
                    navigator.vibrate([50, 30, 50]);
                }
            }

            // 絵文字を飛ばす
            const emojis = isPerfect
                ? ['🎉', '🏆', '👑', '💯', '⭐', '✨', '🌟', '🥇']
                : ['🎉', '⭐', '✨', '👏', '🎊'];
            const count = isPerfect ? 15 : 8;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 3;

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.className = 'celebrate-emoji';
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.left = (centerX - 100 + Math.random() * 200) + 'px';
                    emoji.style.top = (centerY + Math.random() * 50) + 'px';
                    document.body.appendChild(emoji);

                    setTimeout(() => emoji.remove(), 1000);
                }, i * 100);
            }
        }

        // 配列シャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz(mode) {
            document.querySelector('h1').classList.add('hidden');
            document.querySelector('.subtitle').classList.add('hidden');
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('quizArea').classList.remove('hidden');
            document.getElementById('quizTitleHeader').classList.remove('hidden');

            if (mode.startsWith('daily')) {
                isDaily = true;
                const countFromUrl = parseInt(mode.replace('daily', ''));
                totalQuestions = countFromUrl || getDailyQuestionCount();
                questionList = getWeightedRandomQuestions(QUIZ_ID, TOTAL_QUESTIONS, totalQuestions);
            } else {
                // 全問モード
                isDaily = false;
                totalQuestions = TOTAL_QUESTIONS;
                questionList = [...allQuestions];
            }

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if (questionList.includes(i)) {
                    if (i === questionList[0]) {
                        questionElement.classList.remove('hidden');
                    } else {
                        questionElement.classList.add('hidden');
                    }
                } else {
                    if(document.getElementById(`question${i}`)){
                        document.getElementById(`question${i}`).style.display = 'none';
                    }
                }
            }
            
            currentQuestion = 0;
            updateQuestionNumbers();
            document.getElementById('total').textContent = totalQuestions;
            shuffleOptions(questionList[0]);
            updateProgress();
        }

        function getRandomQuestions(count) {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function updateQuestionNumbers() {
            questionList.forEach((questionId, index) => {
                const questionElement = document.getElementById(`question${questionId}`);
                if(questionElement) {
                    const questionNumber = questionElement.querySelector('.question-number');
                    questionNumber.textContent = `問題 ${index + 1}`;
                }
            });
        }

        function shuffleOptions(questionId) {
            if (!questionId) return;
            const container = document
                .getElementById(`question${questionId}`)
                .querySelector('.options');
            if (!container) return;
            
            for (let i = container.children.length; i >= 0; i--) {
                const rand = Math.floor(Math.random() * i);
                if (container.children[rand]) {
                    container.appendChild(container.children[rand]);
                }
            }
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQ').textContent = currentQuestion + 1;
        }

        function selectAnswer(selectedOption) {
            const currentQuestionId = questionList[currentQuestion];
            const currentQuestionElement = document.getElementById(`question${currentQuestionId}`);
            const options = currentQuestionElement.querySelectorAll('.option');
            const feedback = currentQuestionElement.querySelector('.feedback');
            const explanation = currentQuestionElement.querySelector('.explanation');
            const nextButton = document.querySelector('.next-button');
            const resultButton = document.querySelector('.result-button');
            
            const isCorrect = selectedOption.dataset.answer === 'true';
            let correctAnswerText = '';
            
            options.forEach(option => {
                if (option.dataset.answer === 'true') {
                    correctAnswerText = option.textContent;
                }
            });
            
            options.forEach(option => {
                option.classList.add('disabled');
                if (option.dataset.answer === 'true') {
                    option.classList.add('correct');
                } else if (option === selectedOption && option.dataset.answer === 'false') {
                    option.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                feedback.textContent = '🎉 正解です！';
                feedback.className = 'feedback correct';
                score++;
                flashCorrect(selectedOption);
            } else {
                feedback.textContent = `❌ 不正解です。正解は「${correctAnswerText}」です。`;
                feedback.className = 'feedback incorrect';
            }

            // 問題ごとの結果を記録（復習・未挑戦モード用）
            if (typeof recordQuestionResult === 'function') {
                recordQuestionResult(QUIZ_ID, currentQuestionId, isCorrect);
            }

            feedback.style.display = 'block';
            explanation.classList.remove('hidden');

            // スマホ用：回答後にフィードバックが画面上部に来るようスクロール
            setTimeout(() => {
                feedback.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);

            if (currentQuestion < totalQuestions - 1) {
                nextButton.classList.remove('hidden');
            } else {
                resultButton.classList.remove('hidden');
            }
            
            updateScore();
        }

        function nextQuestion() {
            const currentQuestionId = questionList[currentQuestion];
            document.getElementById(`question${currentQuestionId}`).classList.add('hidden');
            
            currentQuestion++;
            const nextQuestionId = questionList[currentQuestion];
            
            shuffleOptions(nextQuestionId);
            document.getElementById(`question${nextQuestionId}`).classList.remove('hidden');
            document.querySelector('.next-button').classList.add('hidden');
            updateProgress();
        }

        function showFinalScore() {
            questionList.forEach(questionId => {
                const qElem = document.getElementById(`question${questionId}`);
                if(qElem) qElem.classList.add('hidden');
            });
            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.quiz-status').classList.add('hidden');
            document.getElementById('quizArea').classList.add('hidden');
            document.querySelector('.quiz-container').classList.add('hidden');

            const percentage = Math.round((score / totalQuestions) * 100);
            let title, message;

            if (score === totalQuestions) {
                title = '🏆 完璧です！ 🏆';
                message = `全問正解！院内ルールを完全に把握していますね。\n自信を持って、日々の業務と患者様対応をお願いします。`;
            } else if (score >= totalQuestions * 0.8) {
                title = '🌟 素晴らしい！ 🌟';
                message = `高得点です！重要なルールはしっかり理解できています。\n間違えた箇所を再確認し、全ての患者様に正確な案内ができるよう目指しましょう。`;
            } else if (score >= totalQuestions * 0.5) {
                title = '👍 あと一歩！ 👍';
                message = `基本的なルールは身についています。\n患者様からの質問が多い項目や、間違いやすい受付時間などを中心に復習しましょう。`;
            } else {
                title = '💪 要復習！ 💪';
                message = `今回は良い復習の機会になりましたね。\n院内マニュアルをもう一度読み返し、正確な知識を身につけましょう。正しい案内が患者様の信頼に繋がります。`;
            }

            const resultTitleHTML = `<div class="result-title">🎊 結果発表 🎊</div>`;
            const scoreHTML = `<span class="final-score-highlight">最終スコア : ${score}/${totalQuestions}（${percentage}%）</span>`;
            const evaluationHTML = `<div class="result-evaluation">${title}</div>`;
            const messageHTML = `<div>${message.replace(/\n/g, '<br>')}</div>`;

            document.getElementById('resultDetail').innerHTML = resultTitleHTML + evaluationHTML + scoreHTML + messageHTML;
            // 進捗表示を追加
            document.getElementById('quizProgressSection').innerHTML = generateProgressHTML('院内ルール確認クイズ', QUIZ_ID, TOTAL_QUESTIONS);

            document.getElementById('finalResult').classList.remove('hidden');
            document.querySelector('.shuffle-button').classList.remove('hidden');
            // ボタンのテキストを設定値に更新
            const dailyCount = getDailyQuestionCount();
            document.getElementById('shuffleButton').innerHTML = '🎲 シャッフル' + dailyCount + '問<span class="btn-sub">別ジャンル</span>';
            document.getElementById('retryButton').innerHTML = '🔄 もう' + dailyCount + '問<span class="btn-sub">同ジャンル</span>';
            document.querySelector('.retry-button').classList.remove('hidden');
            document.querySelector('.record-button').classList.remove('hidden');
            document.querySelector('.home-button-small').classList.remove('hidden');
            document.querySelector('.top-link').classList.add('hidden');

            // トップへスクロール
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // 結果発表エフェクト（満点かどうかで演出を変える）
            const isPerfect = score === totalQuestions;
            setTimeout(() => {
                celebrateResult(isPerfect);
            }, 300);

            // マイページ用に結果を記録
            recordQuizResult(QUIZ_ID, score, totalQuestions);
        }

        function resetQuiz() {
            document.getElementById('finalResult').classList.add('hidden');
            document.querySelector('.quiz-container').classList.remove('hidden');
            score = 0;
            updateScore();

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if(questionElement){
                    questionElement.style.display = '';
                    questionElement.classList.add('hidden');

                    const options = questionElement.querySelectorAll('.option');
                    options.forEach(option => {
                        option.classList.remove('correct', 'incorrect', 'disabled');
                    });

                    questionElement.querySelector('.feedback').style.display = 'none';
                    questionElement.querySelector('.explanation').classList.add('hidden');
                }
            }

            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.shuffle-button').classList.add('hidden');
            document.querySelector('.retry-button').classList.add('hidden');
            document.querySelector('.record-button').classList.add('hidden');
            document.querySelector('.home-button-small').classList.add('hidden');
            document.querySelector('.top-link').classList.remove('hidden');

            document.querySelector('.quiz-status').classList.remove('hidden');

            // 同じモードで再スタート
            if (isDaily) {
                startQuiz('daily');
            } else {
                startQuiz('full');
            }
        }

        function goHome() {
            document.getElementById('finalResult').classList.add('hidden');
            document.getElementById('quizArea').classList.add('hidden');
            document.querySelector('.quiz-container').classList.remove('hidden');
            document.getElementById('quizTitleHeader').classList.add('hidden');

            document.querySelector('h1').classList.remove('hidden');
            document.querySelector('.subtitle').classList.remove('hidden');

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if(questionElement) {
                    questionElement.style.display = '';
                    questionElement.classList.add('hidden');

                    const options = questionElement.querySelectorAll('.option');
                    options.forEach(option => {
                        option.classList.remove('correct', 'incorrect', 'disabled');
                    });

                    questionElement.querySelector('.feedback').style.display = 'none';
                    questionElement.querySelector('.explanation').classList.add('hidden');
                }
            }

            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.shuffle-button').classList.add('hidden');
            document.querySelector('.retry-button').classList.add('hidden');
            document.querySelector('.record-button').classList.add('hidden');
            document.querySelector('.home-button-small').classList.add('hidden');
            document.querySelector('.top-link').classList.remove('hidden');
            document.querySelector('.quiz-status').classList.remove('hidden');

            currentQuestion = 1;
            score = 0;
            totalQuestions = TOTAL_QUESTIONS;
            questionList = [];
            isDaily = false;

            updateScore();
            updateProgressStatus();

            document.getElementById('modeSelection').classList.remove('hidden');
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        // シャッフル3問：別ジャンルのクイズへ
        function goToRandomQuiz() {
            const otherQuizzes = ALL_QUIZZES.filter(q => q !== CURRENT_QUIZ_FILE);
            const randomQuiz = otherQuizzes[Math.floor(Math.random() * otherQuizzes.length)];
            const dailyCount = getDailyQuestionCount();
            window.location.href = encodeURI(randomQuiz) + `?mode=daily${dailyCount}`;
        }

        // もう3問：このクイズの今日の3問を再開
        function restartThisQuiz() {
            const dailyCount = getDailyQuestionCount();
            window.location.href = encodeURI(CURRENT_QUIZ_FILE) + `?mode=daily${dailyCount}`;
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('option') && !e.target.classList.contains('disabled')) {
                selectAnswer(e.target);
            }
        });
    </script>

    <div id="finalResult" class="final-score-card hidden">
      <div id="resultDetail" class="result-detail"></div>
      <div id="quizProgressSection"></div>
      <div class="result-buttons">
        <div class="result-buttons-row">
          <button id="shuffleButton" class="shuffle-button hidden" onclick="goToRandomQuiz()">🎲 シャッフル3問<span class="btn-sub">別ジャンル</span></button>
          <button id="retryButton" class="retry-button hidden" onclick="restartThisQuiz()">🔄 もう3問<span class="btn-sub">同ジャンル</span></button>
        </div>
        <div class="result-buttons-row secondary">
          <a href="../mypage.html" class="record-button hidden">📊 学習記録</a>
          <a href="../index.html" class="home-button-small hidden">🏠 ホーム</a>
        </div>
      </div>
    </div>

</body>
</html>