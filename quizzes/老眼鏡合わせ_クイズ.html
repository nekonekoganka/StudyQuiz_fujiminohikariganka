<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老眼鏡合わせクイズ - スタッフ向け</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans JP', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .quiz-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .quiz-container {
                padding: 20px;
            }
        }
        
        h1 {
            text-align: center;
            color: #1a2937;
            font-size: 28px;
            margin-bottom: 4px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 24px;
            }
        }
        
        .subtitle {
            text-align: center;
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .subtitle {
                font-size: 16px;
            }
        }
        
        .mode-selection {
            text-align: center;
            margin: 40px 0;
        }
        
        .mode-button {
            display: block;
            width: 80%;
            max-width: 400px;
            margin: 15px auto;
            background: linear-gradient(135deg, #d38312, #a86007);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(211, 131, 18, 0.3);
        }
        
        .mode-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(211, 131, 18, 0.4);
        }
        
        @media (max-width: 768px) {
            .mode-button {
                width: 90%;
                padding: 15px 30px;
                font-size: 16px;
                margin: 12px auto;
            }
        }
        
        .mode-description {
            font-size: 14px;
            color: #1a2937;
            margin-top: 20px;
            line-height: 1.5;
        }

        /* 学習状況表示 */
        .progress-status {
            margin: 25px auto 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 14px;
            color: #555;
            max-width: 500px;
        }

        .progress-status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .progress-status-item span:last-child {
            font-weight: bold;
        }

        .top-link {
            display: block;
            text-align: center;
            margin-bottom: 20px;
        }

        .top-link a {
            background: #5e35b1;
            color: white;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 25px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .top-link a:active {
            transform: scale(0.97);
        }

        @media (min-width: 768px) {
            .top-link a:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }
        }

        .question-card {
            background: #fdfdfd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 6px solid #d38312;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            border: 1px solid #ecf0f1;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
        }
        
        .question-number {
            font-weight: bold;
            color: #a86007;
            font-size: 19px;
            margin-bottom: 20px;
            margin-right: 0.75em;
        }
        
        .question-text {
            font-size: 22px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.5;
            flex-grow: 1;
        }
        
        .options, .feedback, .explanation {
            width: 100%;
        }

        @media (max-width: 768px) {
            .question-card {
                padding: 20px;
                display: block;
            }
            .question-number {
                margin-bottom: 12px;
            }
            .question-text {
                font-size: 20px;
            }
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .options {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        
        .option {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .option {
                padding: 15px;
                font-size: 16px;
                min-height: 60px;
            }
        }
        
        .option:hover {
            border-color: #d38312;
            background: #fff8e1;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(211, 131, 18, 0.25);
        }
        .option.correct {
            border-color: #4caf50;
            background: #e8f5e9;
            cursor: default;
            transform: none;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        .option.incorrect {
            border-color: #f44336;
            background: #ffebee;
            cursor: default;
            transform: none;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }
        .option.disabled {
            cursor: default;
            opacity: 0.7;
        }
        .option.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        .next-button, .home-button, .result-button {
            background: linear-gradient(135deg, #d38312, #a86007);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 10px;
            transition: all 0.3s ease;
        }

        .mypage-button {
            background: #00897b;
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 10px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .top-button {
            background: #5e35b1;
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 10px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .next-button, .home-button, .result-button, .mypage-button, .top-button {
                padding: 12px 25px;
                font-size: 16px;
                margin: 10px 5px;
            }
        }

        .next-button:hover, .home-button:hover, .result-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(211, 131, 18, 0.4);
        }

        .mypage-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(38, 166, 154, 0.4);
        }

        .top-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* 結果画面ボタン */
        .result-buttons {
            margin-top: 25px;
        }

        .result-buttons-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .result-buttons-row.secondary {
            margin-bottom: 0;
        }

        .shuffle-button, .retry-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 20px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
            min-width: 140px;
            text-decoration: none;
        }

        .shuffle-button {
            background: #e91e63;
        }

        .retry-button {
            background: #1976d2;
        }

        .btn-sub {
            font-size: 11px;
            font-weight: normal;
            opacity: 0.9;
            margin-top: 3px;
        }

        .record-button, .home-button-small {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .record-button {
            background: #00897b;
        }

        .home-button-small {
            background: #5e35b1;
        }

        .shuffle-button:active, .retry-button:active, .record-button:active, .home-button-small:active {
            transform: scale(0.97);
        }

        @media (min-width: 768px) {
            .shuffle-button:hover, .retry-button:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            }
            .record-button:hover, .home-button-small:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }
        }

        @media (max-width: 768px) {
            .shuffle-button, .retry-button {
                min-width: 130px;
                padding: 12px 16px;
                font-size: 15px;
            }
            .record-button, .home-button-small {
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 18px;
            display: none;
            text-align: center;
        }
        .feedback.correct {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #a5d6a7;
        }
        .feedback.incorrect {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
        }
        
        .quiz-status {
            margin-bottom: 15px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .question-progress {
            font-size: 15px;
            font-weight: bold;
            color: #1a2937;
        }

        .score-display {
            font-size: 15px;
            font-weight: bold;
            color: #1a2937;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ecf0f1;
            border-radius: 2px;
            overflow: hidden;
        }

        /* 問題カード内の問題番号は非表示 */
        .question-number {
            display: none;
        }

        .hidden {
            display: none;
        }
        .buttons {
            text-align: center;
            margin-top: 20px;
        }
        .explanation {
            background: #eef2f3;
            border-left: 5px solid #607d8b;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 18px;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .explanation {
                padding: 15px;
                font-size: 16px;
            }
        }
        
        .staff-point {
            background: #fff8e1;
            border: 2px solid #ffab00;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 18px;
            color: #4e342e;
            line-height: 1.4;
            font-weight: 600;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #d38312, #a86007);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .final-score-card{
            background:#fdfdfd;
            border:2px solid #2c3e50;
            border-radius:15px;
            padding:30px;
            margin-top:30px;
            text-align:center;
            box-shadow:0 3px 15px rgba(0,0,0,.08)
        }
        .result-title {
            font-size:32px;
            font-weight:700;
            color:#1a2937;
            margin-bottom:20px
        }
        
        .result-detail{
            font-size: 20px;
            line-height: 1.8;
            color: #1a2937;
        }

        .result-evaluation {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 25px;
        }

        .final-score-highlight {
            color: #c62828;
            font-weight: bold;
            font-size: 1.5em;
            display: block;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .result-title {font-size:28px}
            .result-detail{font-size:18px;line-height:1.7}
            .result-evaluation {font-size: 22px;}
        }

        /* 正解エフェクト */
        .celebrate-emoji {
            position: fixed;
            font-size: 40px;
            pointer-events: none;
            z-index: 9999;
            animation: celebrate 1s ease-out forwards;
        }

        @keyframes celebrate {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-60px) scale(1.2) rotate(15deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-120px) scale(0.8) rotate(-10deg);
            }
        }

        .correct-flash {
            animation: flashGreen 0.4s ease-out;
        }

        @keyframes flashGreen {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            50% { box-shadow: 0 0 20px 10px rgba(76, 175, 80, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        /* クイズ中タイトル表示 */
        .quiz-title-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            padding: 10px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }

    </style>
</head>
<body>
    <div class="quiz-container">
        <h1>👓 老眼鏡合わせクイズ 👓</h1>
        <div class="subtitle">スタッフ向け - 近用度数決定マスター</div>
        <div id="quizTitleHeader" class="quiz-title-header hidden">👓 老眼鏡合わせクイズ</div>

        <div class="top-link"><a href="../index.html">← トップページへ</a></div>

        <div id="modeSelection" class="mode-selection">
            <button class="mode-button" onclick="startQuiz('daily3')">
                📋 今日の3問
            </button>
            <button class="mode-button" onclick="startQuiz('full')">
                📚 全問モード（全28問）
            </button>

            <div id="progressStatus" class="progress-status">
                <div class="progress-status-item">
                    <span>❌ 間違えた問題:</span>
                    <span id="incorrectCount">0問</span>
                </div>
                <div class="progress-status-item">
                    <span>🆕 未挑戦の問題:</span>
                    <span id="unansweredCount">28問</span>
                </div>
                <div class="progress-status-item">
                    <span>✅ 正解した問題:</span>
                    <span id="correctCount">0問</span>
                </div>
                <div class="progress-status-item">
                    <span>📊 全問題数:</span>
                    <span id="totalQuestionsCount">28問</span>
                </div>
            </div>

            <div class="mode-description">
                <strong>今日の3問:</strong> 間違い・未挑戦を優先出題<br>
                <strong>全問モード:</strong> 全28問を順番に出題
            </div>
        </div>
        
        <div id="quizArea" class="hidden">
            <div class="quiz-status">
                <div class="status-row">
                    <span class="question-progress">問題 <span id="currentQ">1</span> / <span id="total">28</span></span>
                    <span class="score-display">正解: <span id="score">0</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>
            
            <div class="question-card" id="question1">
                <div class="question-number">問題 1</div>
                <div class="question-text">近用眼鏡（老眼鏡）の度数を決める際に、最も重要な患者様からの情報は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">主な使用目的（作業距離）</div>
                    <div class="option" data-answer="false">患者様の年齢</div>
                    <div class="option" data-answer="false">遠くの視力</div>
                    <div class="option" data-answer="false">好きなフレームのデザイン</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>近用度数を決める上で最も重要なのは、患者様が「どのくらいの距離で、何を一番見たいか」という作業距離です。例えば、読書、パソコン作業、手芸など、目的によって最適な度数は異なります。
                </div>
            </div>

            <div class="question-card" id="question2">
                <div class="question-number">問題 2</div>
                <div class="question-text">老眼の初期症状として、正しいものはどれですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">遠くがぼやける</div>
                    <div class="option" data-answer="true">薄暗いと近くが見えにくい</div>
                    <div class="option" data-answer="false">物が二重に見える</div>
                    <div class="option" data-answer="false">涙が止まらない</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>老眼の初期では、明るい場所ではまだピント調節が効くものの、薄暗い場所では瞳孔が開き、ピントの合う範囲（焦点深度）が狭くなるため、見えにくさを感じやすくなります。
                </div>
            </div>

            <div class="question-card hidden" id="question3">
                <div class="question-number">問題 3</div>
                <div class="question-text">近用眼鏡の度数における「加入度（ADD）」とは、何を意味しますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">乱視の度数</div>
                    <div class="option" data-answer="true">遠用度数に付け加えるプラス度数</div>
                    <div class="option" data-answer="false">レンズの厚み</div>
                    <div class="option" data-answer="false">プリズムの度数</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>加入度（ADD）とは、遠くを見るための度数を基準として、近くを見るために追加するプラスレンズの度数のことです。この加入度を調整することで、様々な距離にピントを合わせます。
                </div>
            </div>

            <div class="question-card hidden" id="question4">
                <div class="question-number">問題 4</div>
                <div class="question-text">患者様の年齢から大まかな加入度を予測する「年齢別加入度」で、45歳の平均的な加入度はどれですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">+0.50 D</div>
                    <div class="option" data-answer="true">+1.00 D</div>
                    <div class="option" data-answer="false">+1.50 D</div>
                    <div class="option" data-answer="false">+2.00 D</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>あくまで目安ですが、年齢に応じた標準的な加入度というものがあります。45歳では+1.00Dが平均的な値とされています。
                    <div class="staff-point">
                        <strong>スタッフへのヒント：</strong>この年齢別加入度は、あくまで検査の出発点です。最終的な度数は、必ず患者様の希望する作業距離や自覚的な見え方を確認して決定します。
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question5">
                <div class="question-number">問題 5</div>
                <div class="question-text">近用眼鏡の度数合わせで「二色テスト」を行う目的は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">度数が強すぎたり（過矯正）、弱すぎたり（低矯正）しないかを確認する</div>
                    <div class="option" data-answer="false">乱視の軸が合っているかを確認する</div>
                    <div class="option" data-answer="false">立体視の機能を確認する</div>
                    <div class="option" data-answer="false">色覚異常がないかを確認する</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>二色テスト（赤緑テスト）は、光の波長による焦点距離の違いを利用して、矯正度数が適切かどうかを判断する検査です。「緑がはっきり見える」場合は過矯正（強すぎ）、「赤がはっきり見える」場合は低矯正（弱すぎ）の可能性があります。
                </div>
            </div>

            <div class="question-card hidden" id="question6">
                <div class="question-number">問題 6</div>
                <div class="question-text">近用二色テストで、患者様が「どちらも同じくらいに見える」と答えた場合、次にどちらを優先して調整しますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">緑が少しだけはっきり見える状態</div>
                    <div class="option" data-answer="true">赤が少しだけはっきり見える状態</div>
                    <div class="option" data-answer="false">完全に見え方が同じになるまで調整する</div>
                    <div class="option" data-answer="false">二色テストを終了する</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>「同等」と答えた場合、やや低矯正（赤がハッキリ）側を優先するのが一般的です。過矯正（緑がハッキリ）にすると、目に余分な調節を強いてしまい、疲れやすさの原因となるためです。
                </div>
            </div>

            <div class="question-card hidden" id="question7">
                <div class="question-number">問題 7</div>
                <div class="question-text">近用眼鏡の度数合わせで「クロスシリンダーテスト」を用いる主な目的は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">乱視の度数を測定する</div>
                    <div class="option" data-answer="true">調節力を測定し、適切な加入度を決定する</div>
                    <div class="option" data-answer="false">両眼の視力バランスを調整する</div>
                    <div class="option" data-answer="false">斜位の量を測定する</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>近見でのクロスシリンダーテストは、患者様の調節力を客観的に測定し、それに基づいて適切な加入度を決定するために行われます。格子状の視標を使用するのが特徴です。
                </div>
            </div>

             <div class="question-card" id="question8">
                <div class="question-number">問題 8</div>
                <div class="question-text">患者様が「近くだけでなく、少し先のデスクトップPCの画面も同じメガネで見たい」と希望した場合、どのような度数調整が考えられますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">加入度をさらに強くする</div>
                    <div class="option" data-answer="true">加入度を少し弱めにする</div>
                    <div class="option" data-answer="false">乱視の度数を変える</div>
                    <div class="option" data-answer="false">遠用度数を変える</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>加入度を強くすると、より近い距離にピントが合いますが、ピントの合う範囲（焦点深度）は狭くなります。少し離れたPC画面も見るためには、加入度を少し弱めに設定し、ピントの合う範囲を広げる調整が有効です。
                </div>
            </div>
            
            <div class="question-card" id="question9">
                <div class="question-number">問題 9</div>
                <div class="question-text">「調節力」とは、具体的に目のどの部分の働きを指しますか？</div>
                <div class="options">
                    <div class="option" data-answer="true">水晶体の厚みを変えてピントを合わせる力</div>
                    <div class="option" data-answer="false">瞳孔の大きさを変えて光の量を調節する力</div>
                    <div class="option" data-answer="false">眼球を上下左右に動かす力</div>
                    <div class="option" data-answer="false">涙を分泌して目を潤す力</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>調節力とは、毛様体筋という筋肉を使って水晶体の厚さを変化させ、近くのものにピントを合わせる力のことです。老眼は、この調節力が加齢とともに低下することで起こります。
                </div>
            </div>
            
            <div class="question-card" id="question10">
                <div class="question-number">問題 10</div>
                <div class="question-text">近視の人が初めて老眼鏡を作る場合、どのような選択肢が考えられますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">遠近両用メガネ一択</div>
                    <div class="option" data-answer="false">コンタクトレンズへの変更</div>
                    <div class="option" data-answer="true">遠近両用、近々両用、近用単焦点など、用途に応じて様々</div>
                    <div class="option" data-answer="false">近視の度数を少し弱めるだけ</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>近視の人の場合、①遠近両用メガネ、②遠用メガネと近用メガネの2本持ち、③コンタクトレンズ＋近用メガネ、④近々両用メガネなど、ライフスタイルに合わせて様々な選択肢があります。
                </div>
            </div>

            <div class="question-card" id="question11">
                <div class="question-number">問題 11</div>
                <div class="question-text">調節力を測定する際、患者様の年齢から予測した調節力の何割くらいを楽に使える範囲と考えますか？</div>
                <div class="options">
                    <div class="option" data-answer="true">半分（1/2）程度</div>
                    <div class="option" data-answer="false">すべて（10/10）</div>
                    <div class="option" data-answer="false">2/3程度</div>
                    <div class="option" data-answer="false">1/3程度</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>人間は、持っている調節力のすべてを継続的に使うことはできません。一般的に、持続的に楽に使えるのは最大調節力の半分程度とされています。加入度を計算する際の基本的な考え方です。
                </div>
            </div>

            <div class="question-card" id="question12">
                <div class="question-number">問題 12</div>
                <div class="question-text">患者様が希望する作業距離が40cmの場合、必要な調節力は何ジオプター（D）ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">1.0 D</div>
                    <div class="option" data-answer="false">2.0 D</div>
                    <div class="option" data-answer="true">2.5 D</div>
                    <div class="option" data-answer="false">4.0 D</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>必要な調節力（D）は、「1 ÷ 作業距離(m)」で計算できます。40cmは0.4mなので、「1 ÷ 0.4 = 2.5」となり、2.5ジオプターの調節力が必要です。
                </div>
            </div>
            
            <div class="question-card" id="question13">
                <div class="question-number">問題 13</div>
                <div class="question-text">テスト用のメガネをかけてもらい、患者様に「疲れませんか？」と質問する目的は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">度数が強すぎて、無理な調節をしていないか確認するため</div>
                    <div class="option" data-answer="false">レンズの重さを確認するため</div>
                    <div class="option" data-answer="false">患者様の集中力を確認するため</div>
                    <div class="option" data-answer="false">検査終了の合図</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>度数が強すぎる（過矯正）と、患者様は無意識にピントを奥にずらそうと無理な調節をしてしまいます。これが眼精疲労の原因となるため、装用テストでの問診は非常に重要です。
                </div>
            </div>

            <div class="question-card" id="question14">
                <div class="question-number">問題 14</div>
                <div class="question-text">50歳の患者様（調節力2.0D）が、希望作業距離50cmで楽に作業するための適切な加入度は、計算上いくつですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">+0.50 D</div>
                    <div class="option" data-answer="true">+1.00 D</div>
                    <div class="option" data-answer="false">+1.50 D</div>
                    <div class="option" data-answer="false">+2.00 D</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>①作業に必要な調節力は 1 ÷ 0.5m = 2.0D。②楽に使える調節力は本人の調節力2.0Dの半分で1.0D。③不足分は 2.0D - 1.0D = 1.0D。よって、加入度は+1.00Dとなります。
                </div>
            </div>

            <div class="question-card" id="question15">
                <div class="question-number">問題 15</div>
                <div class="question-text">「遠近両用メガネ」の主なデメリットは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">近くが見えないこと</div>
                    <div class="option" data-answer="true">視野の横側に歪みや揺れを感じること</div>
                    <div class="option" data-answer="false">遠くが見えにくいこと</div>
                    <div class="option" data-answer="false">レンズが非常に厚くなること</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>累進レンズ（遠近両用）は、1枚のレンズで遠くから近くまで見えますが、構造上、レンズの左右の周辺部にピントが合わない「歪み」の領域が生じます。慣れるまで、足元が見えにくかったり、視線を動かしたときに揺れを感じたりすることがあります。
                </div>
            </div>

            <div class="question-card" id="question16">
                <div class="question-number">問題 16</div>
                <div class="question-text">「中近両用メガネ」が最も適しているのは、どのような使い方ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">車の運転と読書</div>
                    <div class="option" data-answer="true">室内でのデスクワークと少し離れた会議室のモニターを見る</div>
                    <div class="option" data-answer="false">屋外でのスポーツ全般</div>
                    <div class="option" data-answer="false">就寝前のベッドでの読書</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>中近両用メガネは、手元の書類からデスクトップPC、少し離れた場所にいる人の顔まで、室内での生活に最適化されています。遠近両用に比べて、中間〜近方の視野が広く、歪みが少ないのが特徴です。ただし、車の運転はできません。
                </div>
            </div>
            
            <div class="question-card" id="question17">
                <div class="question-number">問題 17</div>
                <div class="question-text">「近々両用メガネ」は、どのような人に特に喜ばれますか？</div>
                <div class="options">
                    <div class="option" data-answer="true">デスクトップPCの広い画面と手元の書類を交互に見る人</div>
                    <div class="option" data-answer="false">車の運転がメインの人</div>
                    <div class="option" data-answer="false">遠くの景色とスマートフォンの両方を見たい人</div>
                    <div class="option" data-answer="false">初めて老眼鏡を使う人</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>近々両用メガネは、手元（約30cm）からデスクトップ周辺（約60-80cm）までの視野が非常に広く、歪みも少ないため、長時間のデスクワークを行う方に最適です。「手元専用のワイドレンズ」と考えると分かりやすいです。
                </div>
            </div>

            <div class="question-card" id="question18">
                <div class="question-number">問題 18</div>
                <div class="question-text">眼鏡処方箋に書かれている「P.D.」とは、何を意味しますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">プリズム度数</div>
                    <div class="option" data-answer="false">レンズの直径</div>
                    <div class="option" data-answer="true">瞳孔間距離</div>
                    <div class="option" data-answer="false">処方日</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>P.D.は "Pupillary Distance" の略で、右目の瞳孔の中心から左目の瞳孔の中心までの距離を指します。メガネを正しく作るために非常に重要な値です。
                </div>
            </div>

            <div class="question-card" id="question19">
                <div class="question-number">問題 19</div>
                <div class="question-text">患者様から「市販の老眼鏡ではダメですか？」と聞かれた際の適切な答えはどれですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">「全く問題ありません」</div>
                    <div class="option" data-answer="true">「左右の度数や乱視が合わず、疲れの原因になることがあります」</div>
                    <div class="option" data-answer="false">「市販のものはレンズの質が悪いのでやめた方がいいです」</div>
                    <div class="option" data-answer="false">「法律で禁止されています」</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>市販の老眼鏡は、左右同じ度数で乱視も考慮されていません。多くの人は左右で度数が違ったり乱視があったりするため、合わないメガネは眼精疲労の原因になります。眼科で正確な処方を受けることの重要性を説明しましょう。
                </div>
            </div>

            <div class="question-card" id="question20">
                <div class="question-number">問題 20</div>
                <div class="question-text">新しい近用眼鏡を試す際、患者様にしてもらうと良いことは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">目を閉じてリラックスしてもらう</div>
                    <div class="option" data-answer="true">実際に普段見ている物（スマホ、本など）を見てもらう</div>
                    <div class="option" data-answer="false">遠くの景色を眺めてもらう</div>
                    <div class="option" data-answer="false">目を上下左右に動かしてもらう</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>検査室の視力表だけでなく、実際にそのメガネを使いたい状況（スマホ操作、読書など）を再現してもらうことで、より実践的で満足度の高い度数を決定することができます。
                </div>
            </div>

            <div class="question-card" id="question21">
                <div class="question-number">問題 21</div>
                <div class="question-text">処方した度数で「床が浮いて見える」「歪んで見える」と訴えがあった場合、何が原因と考えられますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">近視の度数が強すぎること</div>
                    <div class="option" data-answer="true">乱視の度数や軸が初めて矯正された、または大きく変化したこと</div>
                    <div class="option" data-answer="false">加入度が強すぎること</div>
                    <div class="option" data-answer="false">レンズのコーティングが合わないこと</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>特に乱視を初めて矯正したり、軸を大きく変更したりした場合、脳が新しい見え方に慣れるまで、空間が歪んで見えることがあります。多くは1〜2週間で慣れますが、慣れそうにない場合は再調整が必要なこともあります。
                </div>
            </div>

            <div class="question-card" id="question22">
                <div class="question-number">問題 22</div>
                <div class="question-text">初めて遠近両用メガネを使う患者様への最も重要なアドバイスは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">顔をあまり動かさず、視線（目）を上下に使って見る練習をすること</div>
                    <div class="option" data-answer="false">最初は近くを見る時だけ使うこと</div>
                    <div class="option" data-answer="false">歪みが気になる場合は、すぐに使用を中止すること</div>
                    <div class="option" data-answer="false">車の運転から慣らしていくこと</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>遠近両用レンズは、見る距離によってレンズの使う部分が異なります。顎を少し引いて上目遣いで遠くを、視線を落として近くを見る、という独特の視線の使い方に慣れることが、使いこなしの最大のポイントです。
                </div>
            </div>

            <div class="question-card" id="question23">
                <div class="question-number">問題 23</div>
                <div class="question-text">「調節痙攣」と「老眼」の共通点は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">どちらも加齢が原因である</div>
                    <div class="option" data-answer="true">どちらも「近くが見えにくい」という症状が出ることがある</div>
                    <div class="option" data-answer="false">どちらも手術でしか治らない</div>
                    <div class="option" data-answer="false">どちらも子どものみに見られる</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>調節痙攣は若い人でも起こり、ピント調節筋が緊張しすぎて遠くも近くも見えにくくなります。老眼は加齢で調節力が衰え、近くが見えにくくなります。症状は似ていますが、メカニズムと治療法は全く異なります。
                </div>
            </div>

            <div class="question-card" id="question24">
                <div class="question-number">問題 24</div>
                <div class="question-text">患者様が「この老眼鏡をかけると、なんだか気分が悪くなる」と訴えています。過矯正以外に考えられる原因は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">レンズに傷が付いている</div>
                    <div class="option" data-answer="false">フレームが重すぎる</div>
                    <div class="option" data-answer="true">左右の度数差が大きい、またはプリズム効果によるもの</div>
                    <div class="option" data-answer="false">気のせいである</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>左右の度数に大きな差がある（不同視）場合や、レンズの中心と瞳孔の位置がずれることで生じるプリズム作用が、不快感や気分の悪さの原因になることがあります。
                </div>
            </div>

            <div class="question-card" id="question25">
                <div class="question-number">問題 25</div>
                <div class="question-text">近用眼鏡のフィッティングで、レンズと目の間の距離（頂間距離）が遠くなると、度数はどう感じられますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">変わらない</div>
                    <div class="option" data-answer="true">プラス度数は強く、マイナス度数は弱く感じられる</div>
                    <div class="option" data-answer="false">プラス度数は弱く、マイナス度数は強く感じられる</div>
                    <div class="option" data-answer="false">乱視だけが強く感じられる</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>頂間距離が変わると、網膜に届く光の屈折効果も変わります。特に度数が強い場合、この変化は無視できません。プラスレンズは離れると効果が強まり、マイナスレンズは弱まります。
                </div>
            </div>

            <div class="question-card" id="question26">
                <div class="question-number">問題 26</div>
                <div class="question-text">パソコン作業用のメガネを処方する際、モニターの距離以外に確認すべき重要なことは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">キーボードのメーカー</div>
                    <div class="option" data-answer="false">椅子の高さ</div>
                    <div class="option" data-answer="true">モニター画面と手元の書類を交互に見るか</div>
                    <div class="option" data-answer="false">部屋の広さ</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>パソコン作業と一言で言っても、画面だけを見るのか、手元の書類も頻繁に見るのかで、最適なレンズの種類（中近か近々かなど）が変わってきます。具体的な作業内容のヒアリングが重要です。
                </div>
            </div>

            <div class="question-card" id="question27">
                <div class="question-number">問題 27</div>
                <div class="question-text">患者様が「今のメガネで遠くは良く見えるが、スマホが見にくい」と訴えています。最も可能性が高いのは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">近視が進行した</div>
                    <div class="option" data-answer="true">老眼（調節力の低下）が始まった、または進行した</div>
                    <div class="option" data-answer="false">乱視が進行した</div>
                    <div class="option" data-answer="false">白内障が始まった</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>遠方の見え方に変化がなく、近方のみが見えにくくなった場合、最も考えられるのは加齢による調節力の低下、つまり老眼です。
                </div>
            </div>

            <div class="question-card" id="question28">
                <div class="question-number">問題 28</div>
                <div class="question-text">眼鏡処方の最終決定において、最も優先されるべきことは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">検査データ上の完全矯正値</div>
                    <div class="option" data-answer="false">年齢相応の平均的な度数</div>
                    <div class="option" data-answer="true">患者様が最も快適で、目的に合った見え方だと感じること</div>
                    <div class="option" data-answer="false">前回と同じ度数</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>検査データはあくまで客観的な指標です。最終的には、トライアルレンズを装用してもらい、実際の使用環境を想定した上で、患者様自身が「これなら快適に使える」と感じる度数に調整することが、満足度の高い眼鏡処方のゴールです。
                </div>
            </div>

            <div class="buttons">
                <button class="next-button hidden" onclick="nextQuestion()">次の問題へ</button>
                <button class="result-button hidden" onclick="showFinalScore()">🎊 結果発表へ 🎊</button>
            </div>
        </div>
    </div>

    <script src="quiz-config.js"></script>
    <script>
        const QUIZ_ID = 'megane-awase';
        const TOTAL_QUESTIONS = 28;

        // 全クイズ一覧（シャッフル機能用）
        const ALL_QUIZZES = [
            'コンタクト処方の基本クイズ.html',
            '大人の遠く用メガネ合わせクイズ.html',
            '弱視クイズ.html',
            '斜視クイズ.html',
            '白内障についてクイズ.html',
            '緑内障についてクイズ.html',
            '老眼鏡合わせ_クイズ.html',
            '自治体の緑内障検診の制度のクイズ.html',
            '花粉症についてのクイズ.html',
            '近視についてのクイズ.html',
            '院内ルール確認クイズ.html'
        ];
        const CURRENT_QUIZ_FILE = decodeURIComponent(location.pathname.split('/').pop());

        let currentQuestion = 1;
        let score = 0;
        let totalQuestions = 28;
        let questionList = [];
        let isDaily = false;

        const allQuestions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28];

        // ページ読み込み時にモードボタンの状態を更新
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressStatus();

            // URLパラメータをチェック
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');

            // モードが指定されていたら自動開始
            if (mode === 'daily3' || mode === 'full') {
                startQuiz(mode);
            }
        });

        // 学習状況の表示を更新
        function updateProgressStatus() {
            const incorrectList = getIncorrectQuestions(QUIZ_ID);
            const unansweredList = getUnansweredQuestions(QUIZ_ID, TOTAL_QUESTIONS);
            const correctNum = TOTAL_QUESTIONS - incorrectList.length - unansweredList.length;

            const incorrectCount = document.getElementById('incorrectCount');
            const unansweredCount = document.getElementById('unansweredCount');
            const correctCount = document.getElementById('correctCount');
            const totalQuestionsCount = document.getElementById('totalQuestionsCount');

            if (incorrectCount) {
                incorrectCount.textContent = `${incorrectList.length}問`;
            }
            if (unansweredCount) {
                unansweredCount.textContent = `${unansweredList.length}問`;
            }
            if (correctCount) {
                correctCount.textContent = `${correctNum}問`;
            }
            if (totalQuestionsCount) {
                totalQuestionsCount.textContent = `${TOTAL_QUESTIONS}問`;
            }
        }

        // 配列シャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 正解時フラッシュ効果
        function flashCorrect(element) {
            const card = element.closest('.question-card');
            if (card) {
                card.classList.add('correct-flash');
                setTimeout(() => card.classList.remove('correct-flash'), 400);
            }
        }

        // 結果発表エフェクト
        function celebrateResult(isPerfect) {
            // 振動フィードバック（スマホのみ）
            if (navigator.vibrate) {
                if (isPerfect) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                } else {
                    navigator.vibrate([50, 30, 50]);
                }
            }

            // 絵文字を飛ばす
            const emojis = isPerfect
                ? ['🎉', '🏆', '👑', '💯', '⭐', '✨', '🌟', '🥇']
                : ['🎉', '⭐', '✨', '👏', '🎊'];
            const count = isPerfect ? 15 : 8;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 3;

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.className = 'celebrate-emoji';
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.left = (centerX - 100 + Math.random() * 200) + 'px';
                    emoji.style.top = (centerY + Math.random() * 50) + 'px';
                    document.body.appendChild(emoji);

                    setTimeout(() => emoji.remove(), 1000);
                }, i * 100);
            }
        }

        function startQuiz(mode) {
            document.querySelector('h1').classList.add('hidden');
            document.querySelector('.subtitle').classList.add('hidden');
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('quizArea').classList.remove('hidden');
            document.getElementById('quizTitleHeader').classList.remove('hidden');

            if (mode === 'daily3') {
                isDaily = true;
                totalQuestions = 3;
                questionList = getWeightedRandomQuestions(QUIZ_ID, TOTAL_QUESTIONS, 3);
            } else {
                isDaily = false;
                totalQuestions = TOTAL_QUESTIONS;
                questionList = [...allQuestions];
            }

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if (questionList.includes(i)) {
                    if (i === questionList[0]) {
                        questionElement.classList.remove('hidden');
                    } else {
                        questionElement.classList.add('hidden');
                    }
                } else {
                    if(document.getElementById(`question${i}`)){
                        document.getElementById(`question${i}`).style.display = 'none';
                    }
                }
            }
            
            currentQuestion = 0;
            updateQuestionNumbers();
            document.getElementById('total').textContent = totalQuestions;
            shuffleOptions(questionList[0]);
            updateProgress();
        }

        function getRandomQuestions(count) {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function updateQuestionNumbers() {
            questionList.forEach((questionId, index) => {
                const questionElement = document.getElementById(`question${questionId}`);
                if(questionElement) {
                    const questionNumber = questionElement.querySelector('.question-number');
                    questionNumber.textContent = `問題 ${index + 1}`;
                }
            });
        }

        function shuffleOptions(questionId) {
            if (!questionId) return;
            const container = document
                .getElementById(`question${questionId}`)
                .querySelector('.options');
            if (!container) return;
            
            for (let i = container.children.length; i >= 0; i--) {
                const rand = Math.floor(Math.random() * i);
                if (container.children[rand]) {
                    container.appendChild(container.children[rand]);
                }
            }
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQ').textContent = currentQuestion + 1;
        }

        function selectAnswer(selectedOption) {
            const currentQuestionId = questionList[currentQuestion];
            const currentQuestionElement = document.getElementById(`question${currentQuestionId}`);
            const options = currentQuestionElement.querySelectorAll('.option');
            const feedback = currentQuestionElement.querySelector('.feedback');
            const explanation = currentQuestionElement.querySelector('.explanation');
            const nextButton = document.querySelector('.next-button');
            const resultButton = document.querySelector('.result-button');
            
            const isCorrect = selectedOption.dataset.answer === 'true';
            let correctAnswerText = '';
            
            options.forEach(option => {
                if (option.dataset.answer === 'true') {
                    correctAnswerText = option.textContent;
                }
            });
            
            options.forEach(option => {
                option.classList.add('disabled');
                if (option.dataset.answer === 'true') {
                    option.classList.add('correct');
                } else if (option === selectedOption && option.dataset.answer === 'false') {
                    option.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                feedback.textContent = '🎉 正解です！';
                feedback.className = 'feedback correct';
                score++;
                flashCorrect(selectedOption);
            } else {
                feedback.textContent = `❌ 不正解です。正解は「${correctAnswerText}」です。`;
                feedback.className = 'feedback incorrect';
            }

            // 問題ごとの結果を記録（復習・未挑戦モード用）
            if (typeof recordQuestionResult === 'function') {
                recordQuestionResult(QUIZ_ID, currentQuestionId, isCorrect);
            }

            feedback.style.display = 'block';
            explanation.classList.remove('hidden');

            // スマホ用：回答後にフィードバックが画面上部に来るようスクロール
            setTimeout(() => {
                feedback.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);

            if (currentQuestion < totalQuestions - 1) {
                nextButton.classList.remove('hidden');
            } else {
                resultButton.classList.remove('hidden');
            }
            
            updateScore();
        }

        function nextQuestion() {
            const currentQuestionId = questionList[currentQuestion];
            document.getElementById(`question${currentQuestionId}`).classList.add('hidden');
            
            currentQuestion++;
            const nextQuestionId = questionList[currentQuestion];
            
            shuffleOptions(nextQuestionId);
            document.getElementById(`question${nextQuestionId}`).classList.remove('hidden');
            document.querySelector('.next-button').classList.add('hidden');
            updateProgress();
        }

        function showFinalScore() {
            questionList.forEach(questionId => {
                const qElem = document.getElementById(`question${questionId}`);
                if(qElem) qElem.classList.add('hidden');
            });
            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.quiz-status').classList.add('hidden');
            document.getElementById('quizArea').classList.add('hidden');
            document.querySelector('.quiz-container').classList.add('hidden');

            const percentage = Math.round((score / totalQuestions) * 100);

            // 結果発表エフェクト（満点かどうかで演出を変える）
            const isPerfect = score === totalQuestions;
            setTimeout(() => {
                celebrateResult(isPerfect);
            }, 300);

            // 結果を記録
            if (typeof recordQuizResult === 'function') {
                recordQuizResult(QUIZ_ID, score, totalQuestions);
            }

            let title, message;

            if (score === totalQuestions) {
                title = '🏆 完璧です！ 🏆';
                message = `全問正解！眼鏡処方の知識はプロフェッショナルレベルです。\n患者様一人ひとりに最適な提案ができますね。`;
            } else if (score >= totalQuestions * 0.8) {
                title = '🌟 素晴らしい！ 🌟';
                message = `高得点です！処方の重要ポイントをしっかり理解されています。\n間違えた箇所を復習し、さらに自信を持って患者様に対応しましょう。`;
            } else if (score >= totalQuestions * 0.5) {
                title = '👍 あと一歩！ 👍';
                message = `基本的な知識は身についています。\n特に専門的なテスト（二色テスト、クロスシリンダー）の目的などを中心に復習すると、理解が深まります。`;
            } else {
                title = '💪 要復習！ 💪';
                message = `良い学習の機会になりましたね。\nこのクイズを元に知識を整理し、明日からの臨床に活かしていきましょう！`;
            }
            
            const resultTitleHTML = `<div class="result-title">🎊 結果発表 🎊</div>`;
            const scoreHTML = `<span class="final-score-highlight">最終スコア : ${score}/${totalQuestions}（${percentage}%）</span>`;
            const evaluationHTML = `<div class="result-evaluation">${title}</div>`;
            const messageHTML = `<div>${message.replace(/\n/g, '<br>')}</div>`;

            document.getElementById('resultDetail').innerHTML = resultTitleHTML + evaluationHTML + scoreHTML + messageHTML;

            document.getElementById('finalResult').classList.remove('hidden');
            document.querySelector('.shuffle-button').classList.remove('hidden');
            document.querySelector('.retry-button').classList.remove('hidden');
            document.querySelector('.record-button').classList.remove('hidden');
            document.querySelector('.home-button-small').classList.remove('hidden');
            document.querySelector('.top-link').classList.add('hidden');

            // トップへスクロール
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetQuiz() {
            document.getElementById('finalResult').classList.add('hidden');
            document.querySelector('.quiz-container').classList.remove('hidden');
            document.querySelector('.top-link').classList.remove('hidden');
            score = 0;
            updateScore();

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if(questionElement){
                    questionElement.style.display = '';
                    questionElement.classList.add('hidden');
                
                    const options = questionElement.querySelectorAll('.option');
                    options.forEach(option => {
                        option.classList.remove('correct', 'incorrect', 'disabled');
                    });
                    
                    questionElement.querySelector('.feedback').style.display = 'none';
                    questionElement.querySelector('.explanation').classList.add('hidden');
                }
            }
            
            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.shuffle-button').classList.add('hidden');
            document.querySelector('.retry-button').classList.add('hidden');
            document.querySelector('.record-button').classList.add('hidden');
            document.querySelector('.home-button-small').classList.add('hidden');

            document.querySelector('.quiz-status').classList.remove('hidden');

            if (totalQuestions === 3) {
                startQuiz('daily3');
            } else {
                startQuiz('full');
            }
        }

        function goHome() {
            document.getElementById('finalResult').classList.add('hidden');
            document.getElementById('quizArea').classList.add('hidden');
            document.querySelector('.quiz-container').classList.remove('hidden');
            document.querySelector('.top-link').classList.remove('hidden');

            document.querySelector('h1').classList.remove('hidden');
            document.querySelector('.subtitle').classList.remove('hidden');
            document.getElementById('quizTitleHeader').classList.add('hidden');

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if(questionElement) {
                    questionElement.style.display = '';
                    questionElement.classList.add('hidden');

                    const options = questionElement.querySelectorAll('.option');
                    options.forEach(option => {
                        option.classList.remove('correct', 'incorrect', 'disabled');
                    });

                    questionElement.querySelector('.feedback').style.display = 'none';
                    questionElement.querySelector('.explanation').classList.add('hidden');
                }
            }

            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.shuffle-button').classList.add('hidden');
            document.querySelector('.retry-button').classList.add('hidden');
            document.querySelector('.record-button').classList.add('hidden');
            document.querySelector('.home-button-small').classList.add('hidden');
            document.querySelector('.quiz-status').classList.remove('hidden');

            currentQuestion = 1;
            score = 0;
            totalQuestions = TOTAL_QUESTIONS;
            questionList = [];
            isDaily = false;

            updateScore();
            updateProgressStatus();

            document.getElementById('modeSelection').classList.remove('hidden');
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function goToRandomQuiz() {
            const otherQuizzes = ALL_QUIZZES.filter(q => q !== CURRENT_QUIZ_FILE);
            const randomQuiz = otherQuizzes[Math.floor(Math.random() * otherQuizzes.length)];
            window.location.href = randomQuiz + '?mode=daily3';
        }

        function restartThisQuiz() {
            resetQuiz();
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('option') && !e.target.classList.contains('disabled')) {
                selectAnswer(e.target);
            }
        });
    </script>

    <div id="finalResult" class="final-score-card hidden">
      <div id="resultDetail" class="result-detail"></div>
      <div class="result-buttons">
        <div class="result-buttons-row">
          <button class="shuffle-button hidden" onclick="goToRandomQuiz()">
            🎲 別のクイズへ
            <span class="btn-sub">ランダム出題</span>
          </button>
          <button class="retry-button hidden" onclick="restartThisQuiz()">
            🔄 もう一度
            <span class="btn-sub">このクイズ</span>
          </button>
        </div>
        <div class="result-buttons-row secondary">
          <a href="../mypage.html" class="record-button hidden">📊 学習記録</a>
          <a href="../index.html" class="home-button-small hidden">🏠 ホーム</a>
        </div>
      </div>
    </div>

</body>
</html>