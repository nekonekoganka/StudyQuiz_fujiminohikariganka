<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>コンタクトレンズ処方クイズ - スタッフ向け</title>
    <link rel="stylesheet" href="../css/quiz.css">
</head>
<body>
    <div class="quiz-container">
        <h1>💧 コンタクトレンズ処方クイズ 💧</h1>
        <div class="subtitle">スタッフ向け - 球面CL処方マスター</div>
        <div id="quizTitleHeader" class="quiz-title-header hidden">💧 コンタクトレンズ処方クイズ</div>
        <div class="top-link"><a href="../index.html">← トップページへ</a></div>

        <div id="modeSelection" class="mode-selection">
            <button class="mode-button" onclick="startQuiz('daily')">
                📋 今日の3問
            </button>
            <button class="mode-button" onclick="startQuiz('full')">
                📚 全問モード（全29問）
            </button>

            <div id="progressStatus" class="progress-status">
                <div class="progress-status-item">
                    <span>❌ 間違えた問題:</span>
                    <span id="incorrectCount">0問</span>
                </div>
                <div class="progress-status-item">
                    <span>🆕 未挑戦の問題:</span>
                    <span id="unansweredCount">29問</span>
                </div>
                <div class="progress-status-item">
                    <span>✅ 正解した問題:</span>
                    <span id="correctCount">0問</span>
                </div>
                <div class="progress-status-item">
                    <span>📊 全問題数:</span>
                    <span id="totalQuestionsCount">29問</span>
                </div>
            </div>

            <button id="reviewModeButton" class="review-mode-button hidden" onclick="startQuiz('review')">
                ❌ 間違えた問題だけ復習
                <span class="btn-sub">苦手を克服しよう</span>
            </button>

            <div class="mode-description">
                <strong>今日の3問:</strong> 間違い・未挑戦を優先出題<br>
                <strong>全問モード:</strong> 全29問を順番に出題
            </div>
        </div>
        
        <div id="quizArea" class="hidden">
            <div class="quiz-status">
                <div class="status-row">
                    <span class="question-progress">問題 <span id="currentQ">1</span> / <span id="total">29</span></span>
                    <span class="score-display">正解: <span id="score">0</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>
            
            <div class="question-card hidden" id="question1">
                <div class="question-number">問題 1</div>
                <div class="question-text">CL処方において、最初に行うことは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">問診（使用目的、コンタクト歴、アレルギー等の聴取）</div>
                    <div class="option" data-answer="false">オートレフでの測定</div>
                    <div class="option" data-answer="false">トライアルレンズの選定</div>
                    <div class="option" data-answer="false">視力検査</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>処方の第一歩は、患者様の希望や生活環境、アレルギーの有無などを詳しく聞く問診です。これにより、最適なレンズの種類や処方方針を立てることができます。
                </div>
            </div>

            <div class="question-card hidden" id="question2">
                <div class="question-number">問題 2</div>
                <div class="question-text">オートレフのK値（ケラト値）は何を測定していますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">眼圧</div>
                    <div class="option" data-answer="false">眼軸長</div>
                    <div class="option" data-answer="true">角膜のカーブ（曲率半径）</div>
                    <div class="option" data-answer="false">角膜の直径</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>K値（ケラトメトリー値）は、角膜のカーブの強さを測定した値です。CLのベースカーブ（BC）を決定するための非常に重要な指標となります。
                </div>
            </div>

            <div class="question-card hidden" id="question3">
                <div class="question-number">問題 3</div>
                <div class="question-text">ソフトコンタクトレンズ（SCL）のベースカーブ（BC）を選ぶ際、K値に対してどう選ぶのが一般的ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">K値と全く同じ値を選ぶ</div>
                    <div class="option" data-answer="true">K値より0.6mm～1.0mm程度大きい（緩い）カーブを選ぶ</div>
                    <div class="option" data-answer="false">K値より小さい（きつい）カーブを選ぶ</div>
                    <div class="option" data-answer="false">K値はBC選択に関係ない</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>SCLは柔らかく、角膜にフィットするため、角膜そのもののカーブ（K値）よりも少し緩めのBCを選ぶのが一般的です。これを「アペックスクリアランス」の考え方に基づいています。
                </div>
            </div>

            <div class="question-card hidden" id="question4">
                <div class="question-number">問題 4</div>
                <div class="question-text">ハードコンタクトレンズ（HCL）のBCを選ぶ際、K値に対してどう選ぶのが一般的ですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">K値にできるだけ近い値を選ぶ（フィッティング重視）</div>
                    <div class="option" data-answer="false">K値より1.0mm以上大きい（緩い）カーブを選ぶ</div>
                    <div class="option" data-answer="false">必ずK値より0.2mm小さい（きつい）カーブを選ぶ</div>
                    <div class="option" data-answer="false">SCLと同じ基準で選ぶ</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>HCLは硬い素材でできているため、角膜の形状に非常に近いBCを選ぶ必要があります。これを「アライメントフィッティング」と呼びます。K値とBCの差が大きいと、レンズが安定しなかったり、角膜に負担をかけたりします。
                </div>
            </div>
            
            <div class="question-card hidden" id="question5">
                <div class="question-number">問題 5</div>
                <div class="question-text">メガネの度数からCLの度数を決定する際に、必ず行わなければならない計算は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">球面等価換算</div>
                    <div class="option" data-answer="true">頂点間距離換算</div>
                    <div class="option" data-answer="false">瞳孔間距離の調整</div>
                    <div class="option" data-answer="false">加入度の計算</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>メガネは目から約12mm離れていますが、CLは角膜の上に直接乗ります。この距離の違いによる度数のズレを補正するのが「頂点間距離換算」です。特に度数が強い場合は必須の計算です。
                    <div class="explanation-image">
                        <img src="../images/explanation/megane/lense_tyoutennkannkyori.png" alt="頂点間距離による度数換算表">
                        <span class="image-caption">頂点間距離による度数換算表（近視・遠視）</span>
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question6">
                <div class="question-number">問題 6</div>
                <div class="question-text">頂点間距離換算を行うと、強い近視（マイナス度数）の場合、CLの度数はメガネの度数と比べてどうなりますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">強くなる（マイナスの数字が大きくなる）</div>
                    <div class="option" data-answer="true">弱くなる（マイナスの数字が小さくなる）</div>
                    <div class="option" data-answer="false">変わらない</div>
                    <div class="option" data-answer="false">プラス度数になる</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>強いマイナス度数のレンズは、目に近づけるほど効果が弱くなります。そのため、メガネ（-8.00Dなど）からコンタクトレンズにする場合、度数は弱く（-7.50Dなど）なります。
                    <div class="explanation-image">
                        <img src="../images/explanation/CL/CL_kinshinodosuukansannhyou.png" alt="近視のレンズ度数換算早見表">
                        <span class="image-caption">近視のレンズ度数換算早見表（コンタクト⇔メガネ）</span>
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question7">
                <div class="question-number">問題 7</div>
                <div class="question-text">SCLのフィッティングを評価する「瞬目テスト」で、理想的なレンズの動きはどれですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">まばたきをした後、レンズがわずかに動き、ゆっくりと元の位置に戻る</div>
                    <div class="option" data-answer="false">まばたきをしても、レンズが全く動かない</div>
                    <div class="option" data-answer="false">まばたきをすると、レンズが上に大きくずれる</div>
                    <div class="option" data-answer="false">レンズが常に下の方に張り付いている</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>適度な動き（0.2～0.4mm程度）は、涙液交換を促し、角膜への酸素供給や老廃物の排出に不可欠です。全く動かないのはタイト（きつい）、動きすぎるのはルーズ（ゆるい）フィッティングと判断されます。
                </div>
            </div>

             <div class="question-card hidden" id="question8">
                <div class="question-number">問題 8</div>
                <div class="question-text">HCLと角膜の間にある涙の層がレンズとして働く効果を何と呼びますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">毛細管現象</div>
                    <div class="option" data-answer="true">涙液レンズ効果</div>
                    <div class="option" data-answer="false">ティンダル現象</div>
                    <div class="option" data-answer="false">マスキング効果</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>HCLと角膜の間にある涙が、レンズのような役割を果たして屈折力を補正する現象を「涙液レンズ効果」と呼びます。これにより、HCLは軽度の角膜乱視であれば、レンズ自体に乱視度数がなくても矯正することが可能です。
                </div>
            </div>
            
            <div class="question-card hidden" id="question9">
                <div class="question-number">問題 9</div>
                <div class="question-text">SCLの処方において、レンズの直径（DIA）が小さすぎるとどうなりますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">レンズが曇りやすくなる</div>
                    <div class="option" data-answer="false">レンズが破れやすくなる</div>
                    <div class="option" data-answer="true">角膜を完全に覆うことができず、レンズの縁が角膜に乗ってしまう</div>
                    <div class="option" data-answer="false">度数が強く感じられる</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>SCLは角膜全体を覆い、その縁が白目の部分（結膜）に乗るのが適切な状態です。DIAが小さすぎると、角膜をカバーしきれず、装用感が悪化したり、角膜に傷をつけたりする原因となります。
                </div>
            </div>
            
            <div class="question-card hidden" id="question10">
                <div class="question-number">問題 10</div>
                <div class="question-text">CLの過矯正（度数が強すぎること）が引き起こす主な問題は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">遠くが見えにくくなる</div>
                    <div class="option" data-answer="true">眼精疲労や頭痛、肩こり</div>
                    <div class="option" data-answer="false">ドライアイ</div>
                    <div class="option" data-answer="false">アレルギー症状の悪化</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>過矯正のレンズを装用すると、目は常にピントを合わせようと無理な調節を強いられるため、毛様体筋が疲労します。これが眼精疲労の主な原因となり、頭痛や肩こりといった身体的な不調につながることもあります。
                </div>
            </div>

            <div class="question-card hidden" id="question11">
                <div class="question-number">問題 11</div>
                <div class="question-text">「トライアルレンズ」を装用してもらう最大の目的は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">レンズの色味を確認してもらうため</div>
                    <div class="option" data-answer="true">実際の見え方や装用感、フィッティングを確認するため</div>
                    <div class="option" data-answer="false">レンズの裏表を確認する練習をしてもらうため</div>
                    <div class="option" data-answer="false">患者様の購入意欲を高めるため</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>計算上のデータだけでは完璧な処方はできません。実際にトライアルレンズを装用し、フィッティング状態、視力、装用感などを総合的に評価・確認することが、安全で快適なコンタクトレンズ処方には不可欠です。
                </div>
            </div>

            <div class="question-card hidden" id="question12">
                <div class="question-number">問題 12</div>
                <div class="question-text">ハードCLがソフトCLより優れている点は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">装用感が良い</div>
                    <div class="option" data-answer="false">スポーツに向いている</div>
                    <div class="option" data-answer="true">乱視矯正力と酸素供給性</div>
                    <div class="option" data-answer="false">価格が安い</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>HCLは硬い素材のため、角膜乱視を涙液レンズ効果で良好に矯正できます。また、レンズが小さく動きがあるため、涙液交換が活発に行われ、角膜への酸素供給性が高いというメリットがあります。
                </div>
            </div>
            
            <div class="question-card hidden" id="question13">
                <div class="question-number">問題 13</div>
                <div class="question-text">CLの上から度数を微調整する「オーバーレフラクション」で、S+0.25Dを入れて視力が変わらない場合、何を意味しますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">度数が弱すぎる</div>
                    <div class="option" data-answer="true">度数が適切、または少し強い可能性がある</div>
                    <div class="option" data-answer="false">乱視がある</div>
                    <div class="option" data-answer="false">レンズが汚れている</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>プラス度数を追加しても視力が低下しないということは、患者様が自身の調節力を使ってそのプラス度数を打ち消していることを意味します。これは、元の度数が適正か、やや過矯正気味であることを示唆します。
                </div>
            </div>

            <div class="question-card hidden" id="question14">
                <div class="question-number">問題 14</div>
                <div class="question-text">ベースカーブ（BC）が角膜に対して「タイト（きつい）」な場合、どのような症状が出やすいですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">レンズがすぐに外れる</div>
                    <div class="option" data-answer="true">圧迫感、充血、視力の不安定</div>
                    <div class="option" data-answer="false">レンズがずれやすい</div>
                    <div class="option" data-answer="false">酸素透過性が 上がる</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>タイトなレンズは角膜を締め付け、涙の交換を妨げます。これにより、圧迫感や充血、酸素不足による角膜のむくみで視力が不安定になるなどの問題が起こります。
                </div>
            </div>

            <div class="question-card hidden" id="question15">
                <div class="question-number">問題 15</div>
                <div class="question-text">ベースカーブ（BC）が角膜に対して「ルーズ（ゆるい）」な場合、どのような症状が出やすいですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">圧迫感と充血</div>
                    <div class="option" data-answer="true">異物感、レンズがずれる、視力が安定しない</div>
                    <div class="option" data-answer="false">目が乾きやすい</div>
                    <div class="option" data-answer="false">レンズが張り付いて取れない</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>ルーズなレンズは角膜上での動きが大きすぎるため、まばたきのたびに異物感を感じたり、視界がクリアでなくなったりします。特に下方視でずれやすいのが特徴です。
                </div>
            </div>

            <div class="question-card hidden" id="question16">
                <div class="question-number">問題 16</div>
                <div class="question-text">初めてCLを使う患者様に、最も重要な指導事項は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">レンズを安く買う方法</div>
                    <div class="option" data-answer="true">正しいレンズケアと、定期検査の重要性</div>
                    <div class="option" data-answer="false">レンズをつけたまま寝ても良いこと</div>
                    <div class="option" data-answer="false">レンズは左右を気にしなくていいこと</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>CLは便利な医療機器ですが、誤った使用は重篤な眼障害につながります。安全に使用するためには、毎日の正しいレンズケア（洗浄・保存）と、自覚症状がなくても眼科医による定期的な検査を受けることが不可欠であることを、強く指導する必要があります。
                </div>
            </div>
            
            <div class="question-card hidden" id="question17">
                <div class="question-number">問題 17</div>
                <div class="question-text">HCLのフィッティングで、フルオレセイン（染色液）を使って観察する目的は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">レンズの傷を確認するため</div>
                    <div class="option" data-answer="true">レンズと角膜の間の涙液層の状態（フィット具合）を確認するため</div>
                    <div class="option" data-answer="false">角膜のカーブを測定するため</div>
                    <div class="option" data-answer="false">レンズの酸素透過性を確認するため</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>フルオレセインは涙液を染色し、ブラックライトで照らすことで、レンズと角膜の間の涙の分布を可視化します。これにより、レンズが角膜に均一に接触しているか（アライメント）、どこかが強く当たったり浮いたりしていないかを詳細に評価できます。
                </div>
            </div>

            <div class="question-card hidden" id="question18">
                <div class="question-number">問題 18</div>
                <div class="question-text">SCLの素材による分類で、「含水率」が高いレンズの特徴として正しいものはどれですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">汚れにくい</div>
                    <div class="option" data-answer="false">耐久性が高い</div>
                    <div class="option" data-answer="true">つけ心地が柔らかいが、乾燥しやすい</div>
                    <div class="option" data-answer="false">酸素を通しにくい</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>高含水レンズは水分を多く含むため、つけ心地が柔らかく、酸素透過性も高い傾向にあります。しかしその反面、レンズ自体の水分が蒸発しやすく、涙を奪ってしまうため、ドライアイの症状を感じやすいというデメリットもあります。
                </div>
            </div>

            <div class="question-card hidden" id="question19">
                <div class="question-number">問題 19</div>
                <div class="question-text">「1日使い捨て（ワンデー）レンズ」の最大のメリットは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">価格が最も安い</div>
                    <div class="option" data-answer="true">毎日新しいレンズで、洗浄の手間がなく衛生的</div>
                    <div class="option" data-answer="false">乱視矯正力が最も高い</div>
                    <div class="option" data-answer="false">酸素透過性が最も高い</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>ワンデータイプの最大の利点は、毎日のレンズケアが不要で、常に清潔な状態のレンズを装用できることです。これにより、レンズの汚れによるトラブルや、ケア用品によるアレルギーのリスクを大幅に減らすことができます。
                </div>
            </div>

            <div class="question-card hidden" id="question20">
                <div class="question-number">問題 20</div>
                <div class="question-text">HCLの処方で、レンズの直径（DIA）を決定する主な要素は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">角膜の直径</div>
                    <div class="option" data-answer="true">まぶたの開き具合（瞼裂の大きさ）</div>
                    <div class="option" data-answer="false">瞳孔の大きさ</div>
                    <div class="option" data-answer="false">BC（ベースカーブ）</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>HCLのDIAは、主に瞼裂の大きさによって決定されます。瞼裂が狭い人に大きいDIAのレンズを入れると、まぶたに引っかかり、フィッティングが不安定になります。
                </div>
            </div>
            
            <div class="question-card hidden" id="question21">
                <div class="question-number">問題 21</div>
                <div class="question-text">CL装用者の定期検査で、スリット（細隙灯顕微鏡）で特に観察すべきことは何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">まつげの長さ</div>
                    <div class="option" data-answer="false">瞳の色</div>
                    <div class="option" data-answer="true">角膜の傷や血管新生、結膜のアレルギー反応の有無</div>
                    <div class="option" data-answer="false">水晶体の濁り</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>定期検査では、レンズによる角膜障害（傷、酸素不足による血管新生など）や、アレルギー性結膜炎（巨大乳頭結膜炎など）が起きていないかを、スリットランプを用いて詳細にチェックすることが最も重要です。
                </div>
            </div>

            <div class="question-card hidden" id="question22">
                <div class="question-number">問題 22</div>
                <div class="question-text">強い近視の患者様にSCLを処方する際、メガネの度数と比べてコンタクトの度数はどうなりますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">強くなる（マイナスの数字が大きくなる）</div>
                    <div class="option" data-answer="true">弱くなる（マイナスの数字が小さくなる）</div>
                    <div class="option" data-answer="false">変わらない</div>
                    <div class="option" data-answer="false">プラス度数になる</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>眼鏡は角膜から約12mm離れた位置で装用されるのに対し、SCLは角膜上に直接装用されます。この頂点間距離の違いにより、近視の場合はSCLの度数は眼鏡より弱くなります（例：眼鏡-6.00D → SCL-5.50D）。覚え方として、近視でも遠視でもSCLは眼鏡に対してプラス方向にシフトします。この差は±4.00D以上で顕著になり、強度近視ほど換算が必要です。
                    <div class="explanation-image">
                        <img src="../images/explanation/CL/CL_kinshinodosuukansannhyou.png" alt="近視のレンズ度数換算早見表">
                        <span class="image-caption">近視のレンズ度数換算早見表（-3.75以下はコンタクトと同じ度数）</span>
                    </div>
                </div>
            </div>

            <div class="question-card hidden" id="question23">
                <div class="question-number">問題 23</div>
                <div class="question-text">患者が「CLは一度つけたら、外すまでずっと見え方は同じ」と考えている場合、なんと説明しますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">「はい、その通りです」</div>
                    <div class="option" data-answer="true">「時間経過による乾燥や汚れで、夕方になると見えにくくなることがあります」</div>
                    <div class="option" data-answer="false">「朝より夜の方が見えやすくなります」</div>
                    <div class="option" data-answer="false">「見え方は度数にしか影響されません」</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>コンタクトレンズは、長時間の装用でレンズ表面が乾燥したり、タンパク質などの汚れが付着したりします。これにより、レンズの光学的な性能が低下し、夕方頃になるとかすみやぼやけを感じることがあります。
                </div>
            </div>

            <div class="question-card hidden" id="question24">
                <div class="question-number">問題 24</div>
                <div class="question-text">HCLの処方で、角膜乱視が-1.50Dある場合、涙液レンズによってどの程度矯正が期待できますか？</div>
                <div class="options">
                    <div class="option" data-answer="false">ほとんど矯正できない</div>
                    <div class="option" data-answer="false">約半分（-0.75D程度）</div>
                    <div class="option" data-answer="true">ほぼ完全に矯正される</div>
                    <div class="option" data-answer="false">過矯正になる</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>HCLは、その硬さによって角膜の形状を涙液レンズで補正するため、中程度までの角膜乱視であれば、球面レンズでも良好な視力が得られることがほとんどです。
                </div>
            </div>

            <div class="question-card hidden" id="question25">
                <div class="question-number">問題 25</div>
                <div class="question-text">SCLのフィッティングで「プッシュアップテスト」を行う目的は何ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">レンズの度数を確認するため</div>
                    <div class="option" data-answer="true">レンズの動き（タイトかルーズか）を確認するため</div>
                    <div class="option" data-answer="false">レンズのセンタリングを確認するため</div>
                    <div class="option" data-answer="false">患者様の協力を得るため</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>医学的な判断が必要な「高度管理医療機器」だからアップテストは、下まぶたでレンズをそっと押し上げて、その動き具合や元の位置に戻るスピードを見ることで、フィッティングの適正度を評価する方法です。瞬目テストと合わせて総合的に判断します。
                </div>
            </div>
            
            <div class="question-card hidden" id="question26">
                <div class="question-number">問題 26</div>
                <div class="question-text">なぜCL処方には、眼科医の診察が法律で義務付けられているのですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">医学的な判断が必要な「高度管理医療機器(クラスⅣ)」だから</div>
                    <div class="option" data-answer="true">医学的な判断が必要な「高度管理医療機器(クラスⅢ)」だから</div>
                    <div class="option" data-answer="false">度数決定が非常に難しいから</div>
                    <div class="option" data-answer="false">メーカーとの契約があるから</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>コンタクトレンズは、心臓のペースメーカーなどと同じ「高度管理医療機器」に分類されます。誤った使用は失明につながる重篤な眼障害を引き起こす可能性があるため、眼科医による診察と処方が不可欠です。
                </div>
            </div>

            <div class="question-card hidden" id="question27">
                <div class="question-number">問題 27</div>
                <div class="question-text">トライアルレンズで「S-3.00Dで1.0」の患者が、より強い「S-3.25Dで1.2」見えた場合、どちらを処方するのが原則ですか？</div>
                <div class="options">
                    <div class="option" data-answer="true">過矯正を避け、日常生活に十分な視力が出ているS-3.00Dを優先する</div>
                    <div class="option" data-answer="false">患者様の希望を優先し、S-3.25Dを処方する</div>
                    <div class="option" data-answer="false">中間をとってS-3.125Dで特注する</div>
                    <div class="option" data-answer="false">どちらも処方せず、再検査とする</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>CL処方の原則は「最高視力の最弱度数」です。1.0の視力で日常生活に支障がないのであれば、眼精疲労の原因となる過矯正を避けるため、より弱いS-3.00Dを選択するのが一般的です。
                </div>
            </div>

            <div class="question-card hidden" id="question28">
                <div class="question-number">問題 28</div>
                <div class="question-text">レンズケースの衛生管理について、患者様にどう指導するのが最も適切ですか？</div>
                <div class="options">
                    <div class="option" data-answer="false">「水道水で毎日洗ってください」</div>
                    <div class="option" data-answer="false">「たまに熱湯消毒してください」</div>
                    <div class="option" data-answer="false">「同じ保存液を継ぎ足して使ってください」</div>
                    <div class="option" data-answer="true">「毎日洗浄・自然乾燥させ、定期的に新しいケースに交換してください」</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>レンズケースは細菌の温床になりやすいです。毎日の洗浄としっかりとした自然乾燥、そして1.5〜3ヶ月ごとの定期的な交換が、感染症予防のために非常に重要です。水道水での洗浄は、アカントアメーバ角膜炎のリスクがあるため厳禁です。
                </div>
            </div>

            <div class="question-card hidden" id="question29">
                <div class="question-number">問題 29</div>
                <div class="question-text">強い遠視の患者様にSCLを処方する際、メガネの度数と比べてコンタクトの度数はどうなりますか？</div>
                <div class="options">
                    <div class="option" data-answer="true">強くなる（プラスの数字が大きくなる）</div>
                    <div class="option" data-answer="false">弱くなる（プラスの数字が小さくなる）</div>
                    <div class="option" data-answer="false">変わらない</div>
                    <div class="option" data-answer="false">マイナス度数になる</div>
                </div>
                <div class="feedback"></div>
                <div class="explanation hidden">
                    <strong>解説：</strong>眼鏡は角膜から約12mm離れた位置で装用されるのに対し、SCLは角膜上に直接装用されます。この頂点間距離の違いにより、遠視の場合はSCLの度数は眼鏡より強くなります（例：眼鏡+6.00D → SCL+6.50D）。覚え方として、近視でも遠視でもSCLは眼鏡に対してプラス方向にシフトします。この差は±4.00D以上で顕著になり、強度遠視ほど換算が必要です。
                    <div class="explanation-image">
                        <img src="../images/explanation/CL/CL_enshinodosuukannsann.png" alt="遠視の度数換算表">
                        <span class="image-caption">遠視の度数換算表（メガネ→コンタクト、頂点間距離別）</span>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button class="next-button hidden" onclick="nextQuestion()">次の問題へ</button>
                <button class="result-button hidden" onclick="showFinalScore()">🎊 結果発表へ 🎊</button>
            </div>
        </div>
    </div>

    <script src="quiz-config.js"></script>
    <script>
        const QUIZ_ID = 'contact-basic';
        const TOTAL_QUESTIONS = 29;

        // 全クイズ一覧（シャッフル機能用）
        const ALL_QUIZZES = [
            'コンタクト処方の基本クイズ.html',
            '大人の遠く用メガネ合わせクイズ.html',
            '弱視クイズ.html',
            '斜視クイズ.html',
            '白内障についてクイズ.html',
            '緑内障についてクイズ.html',
            '老眼鏡合わせ_クイズ.html',
            '自治体の緑内障検診の制度のクイズ.html',
            '花粉症についてのクイズ.html',
            '近視についてのクイズ.html',
            '院内ルール確認クイズ.html'
        ];
        const CURRENT_QUIZ_FILE = decodeURIComponent(location.pathname.split('/').pop());

        let currentQuestion = 1;
        let score = 0;
        let totalQuestions = 29;
        let questionList = [];
        let isDaily = false;

        const allQuestions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29];

        // ページ読み込み時にモードボタンの状態を更新
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressStatus();

            // URLパラメータをチェック
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');

            // 今日の○問ボタンテキストを更新
            const dailyCount = getDailyQuestionCount();
            const dailyBtn = document.querySelector('.mode-button');
            if (dailyBtn && dailyBtn.textContent.includes('今日の')) {
                dailyBtn.textContent = `📋 今日の${dailyCount}問`;
            }

            // モードが指定されていたら自動開始
            if (mode && (mode.startsWith('daily') || mode === 'full' || mode === 'review')) {
                startQuiz(mode);
            }
        });

        // 学習状況の表示を更新
        function updateProgressStatus() {
            const incorrectList = getIncorrectQuestions(QUIZ_ID);
            const unansweredList = getUnansweredQuestions(QUIZ_ID, TOTAL_QUESTIONS);
            const correctNum = TOTAL_QUESTIONS - incorrectList.length - unansweredList.length;

            const incorrectCount = document.getElementById('incorrectCount');
            const unansweredCount = document.getElementById('unansweredCount');
            const correctCount = document.getElementById('correctCount');
            const totalQuestionsCount = document.getElementById('totalQuestionsCount');

            if (incorrectCount) {
                incorrectCount.textContent = `${incorrectList.length}問`;
            }
            if (unansweredCount) {
                unansweredCount.textContent = `${unansweredList.length}問`;
            }
            if (correctCount) {
                correctCount.textContent = `${correctNum}問`;
            }
            if (totalQuestionsCount) {
                totalQuestionsCount.textContent = `${TOTAL_QUESTIONS}問`;
            }

            // 間違えた問題復習ボタンの表示制御
            const reviewModeBtn = document.getElementById('reviewModeButton');
            if (reviewModeBtn) {
                if (incorrectList.length > 0) {
                    reviewModeBtn.classList.remove('hidden');
                    reviewModeBtn.innerHTML = `❌ 間違えた問題だけ復習<span class="btn-sub">${incorrectList.length}問</span>`;
                } else {
                    reviewModeBtn.classList.add('hidden');
                }
            }
        }

        // 配列シャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 正解時フラッシュ効果
        function flashCorrect(element) {
            const card = element.closest('.question-card');
            if (card) {
                card.classList.add('correct-flash');
                setTimeout(() => card.classList.remove('correct-flash'), 400);
            }
        }

        // 結果発表エフェクト
        function celebrateResult(isPerfect) {
            if (navigator.vibrate) {
                if (isPerfect) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                } else {
                    navigator.vibrate([50, 30, 50]);
                }
            }

            const emojis = isPerfect
                ? ['🎉', '🏆', '👑', '💯', '⭐', '✨', '🌟', '🥇']
                : ['🎉', '⭐', '✨', '👏', '🎊'];
            const count = isPerfect ? 15 : 8;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 3;

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.className = 'celebrate-emoji';
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.left = (centerX - 100 + Math.random() * 200) + 'px';
                    emoji.style.top = (centerY + Math.random() * 50) + 'px';
                    document.body.appendChild(emoji);
                    setTimeout(() => emoji.remove(), 1000);
                }, i * 100);
            }
        }

        function startQuiz(mode) {
            document.querySelector('h1').classList.add('hidden');
            document.querySelector('.subtitle').classList.add('hidden');
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('quizArea').classList.remove('hidden');
            document.getElementById('quizTitleHeader').classList.remove('hidden');

            if (mode === 'review') {
                // 間違えた問題のみを出題
                isDaily = false;
                questionList = getIncorrectQuestions(QUIZ_ID);
                if (questionList.length === 0) {
                    // 間違えた問題がない場合はデイリーモードに戻す
                    questionList = getWeightedRandomQuestions(QUIZ_ID, TOTAL_QUESTIONS, getDailyQuestionCount());
                }
                totalQuestions = questionList.length;
            } else if (mode.startsWith('daily')) {
                isDaily = true;
                const countFromUrl = parseInt(mode.replace('daily', ''));
                totalQuestions = countFromUrl || getDailyQuestionCount();
                questionList = getWeightedRandomQuestions(QUIZ_ID, TOTAL_QUESTIONS, totalQuestions);
            } else {
                isDaily = false;
                totalQuestions = TOTAL_QUESTIONS;
                questionList = [...allQuestions];
            }

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if (questionList.includes(i)) {
                    if (i === questionList[0]) {
                        questionElement.classList.remove('hidden');
                    } else {
                        questionElement.classList.add('hidden');
                    }
                } else {
                    if(document.getElementById(`question${i}`)){
                        document.getElementById(`question${i}`).style.display = 'none';
                    }
                }
            }
            
            currentQuestion = 0;
            updateQuestionNumbers();
            document.getElementById('total').textContent = totalQuestions;
            shuffleOptions(questionList[0]);
            updateProgress();
        }

        function getRandomQuestions(count) {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function updateQuestionNumbers() {
            questionList.forEach((questionId, index) => {
                const questionElement = document.getElementById(`question${questionId}`);
                if(questionElement) {
                    const questionNumber = questionElement.querySelector('.question-number');
                    questionNumber.textContent = `問題 ${index + 1}`;
                }
            });
        }

        function shuffleOptions(questionId) {
            if (!questionId) return;
            const container = document
                .getElementById(`question${questionId}`)
                .querySelector('.options');
            if (!container) return;
            
            for (let i = container.children.length; i >= 0; i--) {
                const rand = Math.floor(Math.random() * i);
                if (container.children[rand]) {
                    container.appendChild(container.children[rand]);
                }
            }
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQ').textContent = currentQuestion + 1;
        }

        function selectAnswer(selectedOption) {
            const currentQuestionId = questionList[currentQuestion];
            const currentQuestionElement = document.getElementById(`question${currentQuestionId}`);
            const options = currentQuestionElement.querySelectorAll('.option');
            const feedback = currentQuestionElement.querySelector('.feedback');
            const explanation = currentQuestionElement.querySelector('.explanation');
            const nextButton = document.querySelector('.next-button');
            const resultButton = document.querySelector('.result-button');
            
            const isCorrect = selectedOption.dataset.answer === 'true';
            let correctAnswerText = '';
            
            options.forEach(option => {
                if (option.dataset.answer === 'true') {
                    correctAnswerText = option.textContent;
                }
            });
            
            options.forEach(option => {
                option.classList.add('disabled');
                if (option.dataset.answer === 'true') {
                    option.classList.add('correct');
                } else if (option === selectedOption && option.dataset.answer === 'false') {
                    option.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                feedback.textContent = '🎉 正解です！';
                feedback.className = 'feedback correct';
                score++;
                flashCorrect(selectedOption);
            } else {
                feedback.textContent = `❌ 不正解です。正解は「${correctAnswerText}」です。`;
                feedback.className = 'feedback incorrect';
            }

            // 問題ごとの結果を記録（復習・未挑戦モード用）
            if (typeof recordQuestionResult === 'function') {
                recordQuestionResult(QUIZ_ID, currentQuestionId, isCorrect);
            }

            feedback.style.display = 'block';
            explanation.classList.remove('hidden');

            // スマホ用：回答後にフィードバックが画面上部に来るようスクロール
            setTimeout(() => {
                feedback.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);

            if (currentQuestion < totalQuestions - 1) {
                nextButton.classList.remove('hidden');
            } else {
                resultButton.classList.remove('hidden');
            }
            
            updateScore();
        }

        function nextQuestion() {
            const currentQuestionId = questionList[currentQuestion];
            document.getElementById(`question${currentQuestionId}`).classList.add('hidden');
            
            currentQuestion++;
            const nextQuestionId = questionList[currentQuestion];
            
            shuffleOptions(nextQuestionId);
            document.getElementById(`question${nextQuestionId}`).classList.remove('hidden');
            document.querySelector('.next-button').classList.add('hidden');
            updateProgress();
        }

        function showFinalScore() {
            questionList.forEach(questionId => {
                const qElem = document.getElementById(`question${questionId}`);
                if(qElem) qElem.classList.add('hidden');
            });
            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.quiz-status').classList.add('hidden');
            document.getElementById('quizArea').classList.add('hidden');
            document.querySelector('.quiz-container').classList.add('hidden');

            const percentage = Math.round((score / totalQuestions) * 100);

            // 結果発表エフェクト（満点かどうかで演出を変える）
            const isPerfect = score === totalQuestions;
            setTimeout(() => {
                celebrateResult(isPerfect);
            }, 300);

            // 結果を記録（エラーでも結果画面は表示する）
            let newBadges = [];
            try {
                if (typeof recordQuizResult === 'function') {
                    const result = recordQuizResult(QUIZ_ID, score, totalQuestions);
                    if (result && result._newBadges) {
                        newBadges = result._newBadges;
                    }
                }
            } catch (e) {
                console.error('結果記録中にエラー:', e);
            }

            let title, message;

            if (score === totalQuestions) {
                title = '🏆 完璧です！ 🏆';
                message = `全問正解！CL処方の知識はプロフェッショナルレベルです。\n患者様一人ひとりに安全で最適なレンズを提案できますね。`;
            } else if (score >= totalQuestions * 0.8) {
                title = '🌟 素晴らしい！ 🌟';
                message = `高得点です！処方の重要ポイントをしっかり理解されています。\n間違えた箇所を復習し、さらに自信を持って患者様に対応しましょう。`;
            } else if (score >= totalQuestions * 0.5) {
                title = '👍 あと一歩！ 👍';
                message = `基本的な知識は身についています。\n特にBCやPWRの決定原理、フィッティング評価について復習すると、理解が深まります。`;
            } else {
                title = '💪 要復習！ 💪';
                message = `良い学習の機会になりましたね。\nこのクイズを元に知識を整理し、明日からの臨床に活かしていきましょう！安全なCL処方には正確な知識が不可欠です。`;
            }

            const resultTitleHTML = `<div class="result-title">🎊 結果発表 🎊</div>`;
            const scoreHTML = `<span class="final-score-highlight">最終スコア : ${score}/${totalQuestions}（${percentage}%）</span>`;
            const evaluationHTML = `<div class="result-evaluation">${title}</div>`;
            const messageHTML = `<div>${message.replace(/\n/g, '<br>')}</div>`;

            // 進捗情報を取得して表示（エラー時は空文字）
            let progressHTML = '';
            try {
                progressHTML = generateResultProgressHTML();
            } catch (e) {
                console.error('進捗HTML生成エラー:', e);
            }

            document.getElementById('resultDetail').innerHTML = resultTitleHTML + evaluationHTML + scoreHTML + messageHTML + progressHTML;

            // バッジ獲得表示
            try {
                const badgeArea = document.getElementById('badgeAchievement');
                if (badgeArea && newBadges.length > 0 && typeof renderBadgeAchievement === 'function') {
                    badgeArea.innerHTML = renderBadgeAchievement(newBadges);
                } else if (badgeArea) {
                    badgeArea.innerHTML = '';
                }
            } catch (e) {
                console.error('バッジ表示エラー:', e);
            }

            document.getElementById('finalResult').classList.remove('hidden');
            document.querySelector('.shuffle-button').classList.remove('hidden');
            // ボタンのテキストを設定値に更新
            const dailyCount = getDailyQuestionCount();
            document.getElementById('shuffleButton').innerHTML = '🎲 シャッフル' + dailyCount + '問<span class="btn-sub">別ジャンル</span>';
            document.getElementById('retryButton').innerHTML = '🔄 もう' + dailyCount + '問<span class="btn-sub">同ジャンル</span>';
            document.querySelector('.retry-button').classList.remove('hidden');
            document.querySelector('.record-button').classList.remove('hidden');
            document.querySelector('.home-button-small').classList.remove('hidden');
            document.querySelector('.top-link').classList.add('hidden');

            // 間違えた問題ボタンの表示制御
            const incorrectList = getIncorrectQuestions(QUIZ_ID);
            const reviewBtn = document.getElementById('reviewIncorrectButton');
            if (reviewBtn) {
                if (incorrectList.length > 0) {
                    reviewBtn.classList.remove('hidden');
                    reviewBtn.innerHTML = `❌ 間違えた問題を復習<span class="btn-sub">${incorrectList.length}問</span>`;
                } else {
                    reviewBtn.classList.add('hidden');
                }
            }

            // トップへスクロール
            arrangeResultCards();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetQuiz() {
            document.getElementById('finalResult').classList.add('hidden');
            document.querySelector('.quiz-container').classList.remove('hidden');
            score = 0;
            updateScore();

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if(questionElement){
                    questionElement.style.display = '';
                    questionElement.classList.add('hidden');

                    const options = questionElement.querySelectorAll('.option');
                    options.forEach(option => {
                        option.classList.remove('correct', 'incorrect', 'disabled');
                    });

                    questionElement.querySelector('.feedback').style.display = 'none';
                    questionElement.querySelector('.explanation').classList.add('hidden');
                }
            }

            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.shuffle-button').classList.add('hidden');
            document.querySelector('.retry-button').classList.add('hidden');
            document.querySelector('.record-button').classList.add('hidden');
            document.querySelector('.home-button-small').classList.add('hidden');
            document.querySelector('.top-link').classList.remove('hidden');

            document.querySelector('.quiz-status').classList.remove('hidden');

            if (isDaily) {
                startQuiz('daily');
            } else {
                startQuiz('full');
            }
        }

        function goHome() {
            document.getElementById('finalResult').classList.add('hidden');
            document.getElementById('quizArea').classList.add('hidden');
            document.querySelector('.quiz-container').classList.remove('hidden');

            document.querySelector('h1').classList.remove('hidden');
            document.querySelector('.subtitle').classList.remove('hidden');
            document.getElementById('quizTitleHeader').classList.add('hidden');

            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const questionElement = document.getElementById(`question${i}`);
                if(questionElement) {
                    questionElement.style.display = '';
                    questionElement.classList.add('hidden');

                    const options = questionElement.querySelectorAll('.option');
                    options.forEach(option => {
                        option.classList.remove('correct', 'incorrect', 'disabled');
                    });

                    questionElement.querySelector('.feedback').style.display = 'none';
                    questionElement.querySelector('.explanation').classList.add('hidden');
                }
            }

            document.querySelector('.next-button').classList.add('hidden');
            document.querySelector('.result-button').classList.add('hidden');
            document.querySelector('.shuffle-button').classList.add('hidden');
            document.querySelector('.retry-button').classList.add('hidden');
            document.querySelector('.record-button').classList.add('hidden');
            document.querySelector('.home-button-small').classList.add('hidden');
            document.querySelector('.top-link').classList.remove('hidden');
            document.querySelector('.quiz-status').classList.remove('hidden');

            currentQuestion = 1;
            score = 0;
            totalQuestions = TOTAL_QUESTIONS;
            questionList = [];
            isDaily = false;

            updateScore();
            updateProgressStatus();

            document.getElementById('modeSelection').classList.remove('hidden');
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        // リザルト画面用の進捗HTML生成
        function generateResultProgressHTML() {
            const incorrectList = getIncorrectQuestions(QUIZ_ID);
            const unansweredList = getUnansweredQuestions(QUIZ_ID, TOTAL_QUESTIONS);
            const correctNum = TOTAL_QUESTIONS - incorrectList.length - unansweredList.length;
            const progressPercent = Math.round((correctNum / TOTAL_QUESTIONS) * 100);
            const isPerfect = correctNum === TOTAL_QUESTIONS;

            return `
                <div class="result-progress-section">
                    <div class="result-progress-title">📊 このクイズの進捗</div>
                    <div class="result-progress-bar-container">
                        <div class="result-progress-bar-fill ${isPerfect ? 'perfect' : ''}" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="result-progress-percentage">${isPerfect ? '🌸 ' : ''}${progressPercent}%${isPerfect ? ' マスター！' : ''}</div>
                    <div class="result-progress-stats">
                        <div class="result-progress-stat">
                            <span>✅ 正解</span>
                            <span>${correctNum}問</span>
                        </div>
                        <div class="result-progress-stat">
                            <span>❌ 間違い</span>
                            <span>${incorrectList.length}問</span>
                        </div>
                        <div class="result-progress-stat">
                            <span>🆕 未挑戦</span>
                            <span>${unansweredList.length}問</span>
                        </div>
                        <div class="result-progress-stat">
                            <span>📝 全問題</span>
                            <span>${TOTAL_QUESTIONS}問</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // シャッフル3問：別ジャンルのクイズへ
        function goToRandomQuiz() {
            // 重み付けでクイズを選択（未挑戦・間違いが多いクイズを優先）
            const selectedQuiz = getWeightedRandomQuiz(CURRENT_QUIZ_FILE);
            if (!selectedQuiz) {
                // フォールバック: 従来のランダム選択
                const otherQuizzes = ALL_QUIZZES.filter(q => q !== CURRENT_QUIZ_FILE);
                const randomQuiz = otherQuizzes[Math.floor(Math.random() * otherQuizzes.length)];
                const dailyCount = getDailyQuestionCount();
                window.location.href = encodeURI(randomQuiz) + `?mode=daily${dailyCount}`;
                return;
            }
            const dailyCount = getDailyQuestionCount();
            window.location.href = encodeURI(selectedQuiz) + `?mode=daily${dailyCount}`;
        }

        // もう3問：このクイズの今日の3問を再開
        function restartThisQuiz() {
            const dailyCount = getDailyQuestionCount();
            window.location.href = encodeURI(CURRENT_QUIZ_FILE) + `?mode=daily`;
        }

        // 間違えた問題を復習
        function reviewIncorrectQuestions() {
            const incorrectList = getIncorrectQuestions(QUIZ_ID);
            if (incorrectList.length === 0) return;

            // 間違えた問題数をURLパラメータとして渡す
            window.location.href = encodeURI(CURRENT_QUIZ_FILE) + `?mode=review`;
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('option') && !e.target.classList.contains('disabled')) {
                selectAnswer(e.target);
            }
        });
    </script>

    <div id="finalResult" class="final-score-card hidden">
      <div id="resultDetail" class="result-detail"></div>
      <div id="badgeAchievement"></div>
      <div class="result-buttons">
        <div class="result-buttons-row primary">
          <button id="shuffleButton" class="shuffle-button hidden" onclick="goToRandomQuiz()">🎲 シャッフル3問<span class="btn-sub">別ジャンル</span></button>
          <button id="retryButton" class="retry-button hidden" onclick="restartThisQuiz()">🔄 もう3問<span class="btn-sub">同ジャンル</span></button>
        </div>
        <div class="result-buttons-row" style="margin-bottom: 12px;">
          <button id="reviewIncorrectButton" class="review-incorrect-button hidden" onclick="reviewIncorrectQuestions()">
            ❌ 間違えた問題を復習
            <span class="btn-sub">苦手を克服</span>
          </button>
        </div>
        <div class="result-buttons-row secondary">
          <a href="../mypage.html" class="record-button hidden">📊 記録</a>
          <a href="../index.html" class="home-button-small hidden">🏠 ホーム</a>
        </div>
      </div>
    </div>

</body>
</html>